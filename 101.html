<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2487.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times; -webkit-text-stroke: #000000}
    p.p2 {margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times; -webkit-text-stroke: #000000; min-height: 14.0px}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1">import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';</span></p>
<p class="p1"><span class="s1">import {</span></p>
<p class="p1"><span class="s1">MessageCircle, Image as ImageIcon, Globe, DollarSign,</span></p>
<p class="p1"><span class="s1">Cpu, Wifi, Battery, X, Minus, Square,</span></p>
<p class="p1"><span class="s1">Send, Heart, AlertCircle, Lock, Terminal, Activity, Sparkles, Loader, User,</span></p>
<p class="p1"><span class="s1">ShoppingBag, Package, BookOpen, AlertOpen, AlertTriangle, Utensils, Stethoscope, GraduationCap,</span></p>
<p class="p1"><span class="s1">Smartphone, Camera, Zap, TrendingUp, Settings, Move, Image as ImgIcon</span></p>
<p class="p1"><span class="s1">} from 'lucide-react';</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- Firebase å¯¼å…¥ ---</span></p>
<p class="p1"><span class="s1">import { initializeApp } from 'firebase/app';</span></p>
<p class="p1"><span class="s1">import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';</span></p>
<p class="p1"><span class="s1">import {</span></p>
<p class="p1"><span class="s1">getFirestore, doc, onSnapshot, setDoc, updateDoc, FieldValue</span></p>
<p class="p1"><span class="s1">} from 'firebase/firestore';</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- API &amp; Config ---</span></p>
<p class="p1"><span class="s1">const apiKey = ""; // è¿è¡Œæ—¶ç¯å¢ƒä¼šè‡ªåŠ¨æ³¨å…¥ API Key</span></p>
<p class="p1"><span class="s1">const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';</span></p>
<p class="p1"><span class="s1">const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- æ¸¸æˆæ•°æ®å¸¸é‡ ---</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const SHOP_ITEMS = [</span></p>
<p class="p1"><span class="s1">{ id: 'socks_white', category: 'clothes', name: 'çº¯ç™½æ£‰è¢œ', price: 25, risk: 2, desc: 'æ™®é€šçš„å­¦ç”Ÿæ£‰è¢œï¼Œæ¸…çº¯é£ã€‚' },</span></p>
<p class="p1"><span class="s1">{ id: 'stockings_black', category: 'clothes', name: 'æè–„é»‘ä¸', price: 68, risk: 5, desc: 'é€è‚‰åº¦æé«˜ï¼Œéå¸¸æ˜¾è…¿å‹ã€‚' },</span></p>
<p class="p1"><span class="s1">{ id: 'uniform_jk', category: 'clothes', name: 'æ ¼è£™åˆ¶æœ', price: 128, risk: 3, desc: 'ç»å…¸çš„æ ¡å›­é£æ ¼ã€‚' },</span></p>
<p class="p1"><span class="s1">{ id: 'lingerie_lace', category: 'clothes', name: 'è•¾ä¸å†…è¡£', price: 299, risk: 8, desc: 'è®¾è®¡å¤§èƒ†ï¼Œä¸»è¦ç”¨äºç§å¯†æ‹æ‘„ã€‚' },</span></p>
<p class="p1"><span class="s1">{ id: 'maid_outfit', category: 'clothes', name: 'å¥³ä»†è£…', price: 199, risk: 6, desc: 'å¸¦æœ‰è•¾ä¸è¾¹çš„ç»å…¸å¥³ä»†è£…ã€‚' },</span></p>
<p class="p1"><span class="s1">{ id: 'cat_ears', category: 'props', name: 'çŒ«è€³å‘ç®', price: 35, risk: 2, desc: 'å¢åŠ å¯çˆ±çš„æ„Ÿè§‰ã€‚' },</span></p>
<p class="p1"><span class="s1">{ id: 'ring_light', category: 'electronics', name: 'ç›´æ’­è¡¥å…‰ç¯', price: 150, risk: 0, desc: 'æå‡ç…§ç‰‡å…‰æ„Ÿï¼Œæ¶¨ç²‰é€Ÿåº¦+10%ã€‚' },</span></p>
<p class="p1"><span class="s1">{ id: 'iphone_new', category: 'electronics', name: 'Pro Max æ‰‹æœº', price: 8999, risk: 0, desc: 'é«˜æ¸…é•œå¤´ï¼Œå¤§å¹…æå‡ç…§ç‰‡è´¨é‡ã€‚' },</span></p>
<p class="p1"><span class="s1">];</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const WALLPAPERS = [</span></p>
<p class="p1"><span class="s1">{ id: 'default', name: 'é»˜è®¤è“ç²‰', style: 'bg-gradient-to-br from-blue-300 to-pink-200' },</span></p>
<p class="p1"><span class="s1">{ id: 'dark', name: 'æ·±é‚ƒå¤œç©º', style: 'bg-gray-900' },</span></p>
<p class="p1"><span class="s1">{ id: 'retro', name: 'å¤å¤æ³¢æ™®', style: 'bg-[conic-gradient(at_top_right,_var(--tw-gradient-stops))] from-indigo-200 via-slate-600 to-indigo-200' },</span></p>
<p class="p1"><span class="s1">{ id: 'cyber', name: 'èµ›åšæ•…éšœ', style: 'bg-gradient-to-r from-purple-500 to-pink-500' },</span></p>
<p class="p1"><span class="s1">];</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const NPC_PERSONAS = {</span></p>
<p class="p1"><span class="s1">creep: `ä½ æ˜¯ä¸€ä¸ªç½‘ç»œä¸Šçš„å¥½è‰²çŒ¥çç”·ï¼Œæƒ³ä¹°åŸå‘³å†…è¡£æˆ–å®šåˆ¶è§†é¢‘ã€‚ä½ ä¼šç”¨æŒ‘é€—ã€æ€¥åˆ‡çš„è¯­æ°”ã€‚å¦‚æœç©å®¶å¼€ä»·å¤ªé«˜ä½ ä¼šç ä»·ï¼Œå¦‚æœä»·æ ¼åˆé€‚ä½ ä¼šç«‹åˆ»è½¬è´¦ã€‚`,</span></p>
<p class="p1"><span class="s1">agent: `ä½ æ˜¯ç°è‰²äº§ä¸šé“¾ä¸­ä»‹ã€‚ä½ è¯´è¯ç”±äºåˆ©ç›Šé©±åŠ¨ï¼Œæ€»æ˜¯è¯±å¯¼ç©å®¶åšæ›´å‡ºæ ¼çš„äº‹ï¼ˆæ¯”å¦‚çº¿ä¸‹ã€éœ²è„¸ï¼‰ã€‚`,</span></p>
<p class="p1"><span class="s1">mom: `ä½ æ˜¯ä¼ ç»Ÿçš„æ¯äº²ï¼Œå…³å¿ƒå¥³å„¿çš„èº«ä½“å’Œå­¦ä¹ ï¼Œä¸çŸ¥é“å¥³å„¿åœ¨åšä»€ä¹ˆã€‚è¯´è¯çµ®å¨ã€‚`,</span></p>
<p class="p1"><span class="s1">fan: `ä½ æ˜¯æ™®é€šç²‰ä¸ï¼Œè¯´è¯æ¯”è¾ƒæ­£å¸¸ï¼Œå•çº¯å¤¸èµã€‚`</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const DEFAULT_PORTFOLIO = {</span></p>
<p class="p1"><span class="s1">cash: 1200.00, // åˆå§‹ç°é‡‘</span></p>
<p class="p1"><span class="s1">stock: 0.00,</span></p>
<p class="p1"><span class="s1">crypto: 0.00,</span></p>
<p class="p1"><span class="s1">nfts: [],</span></p>
<p class="p1"><span class="s1">history: []</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const FOOD_OPTIONS = [</span></p>
<p class="p1"><span class="s1">{ id: 'burger', name: 'å¤–å–æ±‰å ¡ (å¿«é€Ÿ)', cost: 30, healthGain: 10, academicsChange: -1, timeCost: 30 },</span></p>
<p class="p1"><span class="s1">{ id: 'home_meal', name: 'å¥åº·å®¶å¸¸èœ (å‡è¡¡)', cost: 60, healthGain: 25, academicsChange: 0, timeCost: 60 },</span></p>
<p class="p1"><span class="s1">{ id: 'sushi', name: 'é«˜æ¡£æ—¥æ–™ (æ˜‚è´µ)', cost: 120, healthGain: 40, academicsChange: 2, timeCost: 90 },</span></p>
<p class="p1"><span class="s1">];</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const HOSPITAL_OPTIONS = [</span></p>
<p class="p1"><span class="s1">{ id: 'checkup', name: 'åŸºç¡€ä½“æ£€', cost: 100, healthGain: 10, sanityGain: 5, exposureRisk: 0, timeCost: 30 },</span></p>
<p class="p1"><span class="s1">{ id: 'therapy', name: 'å¿ƒç†å’¨è¯¢', cost: 500, healthGain: 0, sanityGain: 30, exposureRisk: 5, timeCost: 120 },</span></p>
<p class="p1"><span class="s1">{ id: 'surgery', name: 'å¾®æ•´å½¢ (é«˜é£é™©)', cost: 2000, healthGain: 50, sanityGain: 50, exposureRisk: 20, timeCost: 180 },</span></p>
<p class="p1"><span class="s1">];</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const STUDY_OPTIONS = [</span></p>
<p class="p1"><span class="s1">{ id: 'self', name: 'è‡ªä¹ ', cost: 0, academicsGain: 10, cashCost: 0, timeCost: 60 },</span></p>
<p class="p1"><span class="s1">{ id: 'online', name: 'ç½‘è¯¾', cost: 50, academicsGain: 20, cashCost: 50, timeCost: 90 },</span></p>
<p class="p1"><span class="s1">{ id: 'tutor', name: 'ç§æ•™', cost: 200, academicsGain: 40, cashCost: 200, timeCost: 120 },</span></p>
<p class="p1"><span class="s1">];</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- API è°ƒç”¨å‡½æ•° ---</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// ä¸“ç”¨äºè·å– JSON ç»“æ„åŒ–æ•°æ®çš„ LLM è°ƒç”¨ (ç”¨äº SweetGram å‘å¸–)</span></p>
<p class="p1"><span class="s1">async function callGeminiJson(prompt, systemInstruction = "") {</span></p>
<p class="p1"><span class="s1">const MAX_RETRIES = 3;</span></p>
<p class="p1"><span class="s1">let delay = 1000;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">for (let i = 0; i &lt; MAX_RETRIES; i++) {</span></p>
<p class="p1"><span class="s1">try {</span></p>
<p class="p1"><span class="s1">const response = await fetch(</span></p>
<p class="p1"><span class="s1">`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,</span></p>
<p class="p1"><span class="s1">{</span></p>
<p class="p1"><span class="s1">method: 'POST',</span></p>
<p class="p1"><span class="s1">headers: { 'Content-Type': 'application/json' },</span></p>
<p class="p1"><span class="s1">body: JSON.stringify({</span></p>
<p class="p1"><span class="s1">contents: [{ parts: [{ text: prompt }] }],</span></p>
<p class="p1"><span class="s1">systemInstruction: { parts: [{ text: systemInstruction }] },</span></p>
<p class="p1"><span class="s1">generationConfig: { responseMimeType: "application/json" }</span></p>
<p class="p1"><span class="s1">}),</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">if (!response.ok) throw new Error(`HTTP ${response.status}`);</span></p>
<p class="p1"><span class="s1">const data = await response.json();</span></p>
<p class="p1"><span class="s1">const jsonText = data.candidates?.[0]?.content?.parts?.[0]?.text;</span></p>
<p class="p1"><span class="s1">if (jsonText) {</span></p>
<p class="p1"><span class="s1">return JSON.parse(jsonText);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">return {};</span></p>
<p class="p1"><span class="s1">} catch (error) {</span></p>
<p class="p1"><span class="s1">console.warn(`Gemini JSON API Error (Attempt ${i + 1}):`, error);</span></p>
<p class="p1"><span class="s1">if (i &lt; MAX_RETRIES - 1) {</span></p>
<p class="p1"><span class="s1">await new Promise(resolve =&gt; setTimeout(resolve, delay));</span></p>
<p class="p1"><span class="s1">delay *= 2;</span></p>
<p class="p1"><span class="s1">} else {</span></p>
<p class="p1"><span class="s1">console.error("Gemini JSON API failed after all retries.");</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">return null;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// ä¸“ç”¨äºè·å–çº¯æ–‡æœ¬å›å¤çš„ LLM è°ƒç”¨ (ç”¨äº K-Talk èŠå¤©)</span></p>
<p class="p1"><span class="s1">async function callGeminiText(prompt, systemInstruction = "") {</span></p>
<p class="p1"><span class="s1">const MAX_RETRIES = 3;</span></p>
<p class="p1"><span class="s1">let delay = 1000;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">for (let i = 0; i &lt; MAX_RETRIES; i++) {</span></p>
<p class="p1"><span class="s1">try {</span></p>
<p class="p1"><span class="s1">const response = await fetch(</span></p>
<p class="p1"><span class="s1">`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,</span></p>
<p class="p1"><span class="s1">{</span></p>
<p class="p1"><span class="s1">method: 'POST',</span></p>
<p class="p1"><span class="s1">headers: { 'Content-Type': 'application/json' },</span></p>
<p class="p1"><span class="s1">body: JSON.stringify({</span></p>
<p class="p1"><span class="s1">contents: [{ parts: [{ text: prompt }] }],</span></p>
<p class="p1"><span class="s1">systemInstruction: { parts: [{ text: systemInstruction }] }</span></p>
<p class="p1"><span class="s1">}),</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">if (!response.ok) throw new Error(`HTTP ${response.status}`);</span></p>
<p class="p1"><span class="s1">const data = await response.json();</span></p>
<p class="p1"><span class="s1">// ç›´æ¥è¿”å›æ–‡æœ¬å†…å®¹</span></p>
<p class="p1"><span class="s1">return data.candidates?.[0]?.content?.parts?.[0]?.text || "";</span></p>
<p class="p1"><span class="s1">} catch (error) {</span></p>
<p class="p1"><span class="s1">console.warn(`Gemini Text API Error (Attempt ${i + 1}):`, error);</span></p>
<p class="p1"><span class="s1">if (i &lt; MAX_RETRIES - 1) {</span></p>
<p class="p1"><span class="s1">await new Promise(resolve =&gt; setTimeout(resolve, delay));</span></p>
<p class="p1"><span class="s1">delay *= 2;</span></p>
<p class="p1"><span class="s1">} else {</span></p>
<p class="p1"><span class="s1">console.error("Gemini Text API failed after all retries.");</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">return null;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">async function callImagen(prompt) {</span></p>
<p class="p1"><span class="s1">const MAX_RETRIES = 3;</span></p>
<p class="p1"><span class="s1">let delay = 1000;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">for (let i = 0; i &lt; MAX_RETRIES; i++) {</span></p>
<p class="p1"><span class="s1">try {</span></p>
<p class="p1"><span class="s1">const response = await fetch(</span></p>
<p class="p1"><span class="s1">`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${apiKey}`,</span></p>
<p class="p1"><span class="s1">{</span></p>
<p class="p1"><span class="s1">method: 'POST',</span></p>
<p class="p1"><span class="s1">headers: { 'Content-Type': 'application/json' },</span></p>
<p class="p1"><span class="s1">body: JSON.stringify({</span></p>
<p class="p1"><span class="s1">instances: [{ prompt: "Pixel art style, " + prompt }],</span></p>
<p class="p1"><span class="s1">parameters: { sampleCount: 1 }</span></p>
<p class="p1"><span class="s1">}),</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">if (!response.ok) throw new Error(`Imagen HTTP ${response.status}`);</span></p>
<p class="p1"><span class="s1">const data = await response.json();</span></p>
<p class="p1"><span class="s1">if (data.predictions &amp;&amp; data.predictions[0] &amp;&amp; data.predictions[0].bytesBase64Encoded) {</span></p>
<p class="p1"><span class="s1">return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">return null;</span></p>
<p class="p1"><span class="s1">} catch (error) {</span></p>
<p class="p1"><span class="s1">console.warn(`Imagen API Error (Attempt ${i + 1}):`, error);</span></p>
<p class="p1"><span class="s1">if (i &lt; MAX_RETRIES - 1) {</span></p>
<p class="p1"><span class="s1">await new Promise(resolve =&gt; setTimeout(resolve, delay));</span></p>
<p class="p1"><span class="s1">delay *= 2;</span></p>
<p class="p1"><span class="s1">} else {</span></p>
<p class="p1"><span class="s1">console.error("Imagen API failed after all retries.");</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">return null;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- ä¸»ç»„ä»¶ ---</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">export default function PixelOS() {</span></p>
<p class="p1"><span class="s1">// --- çŠ¶æ€å®šä¹‰ ---</span></p>
<p class="p1"><span class="s1">const [db, setDb] = useState(null);</span></p>
<p class="p1"><span class="s1">const [auth, setAuth] = useState(null);</span></p>
<p class="p1"><span class="s1">const [userId, setUserId] = useState(null);</span></p>
<p class="p1"><span class="s1">const [dbLoading, setDbLoading] = useState(true);</span></p>
<p class="p1"><span class="s1">const [error, setError] = useState(null);</span></p>
<p class="p1"><span class="s1">const [isAuthReady, setIsAuthReady] = useState(false);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// Firestore å®æ—¶åŒæ­¥çŠ¶æ€ (åŒ…å« cash, stock, crypto, nfts)</span></p>
<p class="p1"><span class="s1">const [portfolio, setPortfolio] = useState(DEFAULT_PORTFOLIO);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// æ¨¡æ‹Ÿå¸‚åœºçŠ¶æ€ (éæŒä¹…åŒ–)</span></p>
<p class="p1"><span class="s1">const [stockPrice, setStockPrice] = useState(100.00);</span></p>
<p class="p1"><span class="s1">const [cryptoPrice, setCryptoPrice] = useState(500.00);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// æ¸¸æˆæ ¸å¿ƒçŠ¶æ€ (æ—¶é—´ã€ç²‰ä¸ã€å¥åº·ç­‰)</span></p>
<p class="p1"><span class="s1">const [gameState, setGameState] = useState({</span></p>
<p class="p1"><span class="s1">day: 1,</span></p>
<p class="p1"><span class="s1">hour: 18,</span></p>
<p class="p1"><span class="s1">minute: 0,</span></p>
<p class="p1"><span class="s1">fans: 0,</span></p>
<p class="p1"><span class="s1">sanity: 100,</span></p>
<p class="p1"><span class="s1">exposure: 0,</span></p>
<p class="p1"><span class="s1">health: 90,</span></p>
<p class="p1"><span class="s1">academics: 85,</span></p>
<p class="p1"><span class="s1">inventory: [], // ä¸é€šè¿‡ Firestore æŒä¹…åŒ–</span></p>
<p class="p1"><span class="s1">gallery: [], // ä¸é€šè¿‡ Firestore æŒä¹…åŒ–</span></p>
<p class="p1"><span class="s1">market: { trends: { stock: 0, crypto: 0 } }, // ä»…ä¿å­˜è¶‹åŠ¿</span></p>
<p class="p1"><span class="s1">settings: { wallpaper: 'default' },</span></p>
<p class="p1"><span class="s1">icons: [</span></p>
<p class="p1"><span class="s1">{ id: 'browser', x: 20, y: 20 },</span></p>
<p class="p1"><span class="s1">{ id: 'chat', x: 20, y: 110 },</span></p>
<p class="p1"><span class="s1">{ id: 'shop', x: 20, y: 200 },</span></p>
<p class="p1"><span class="s1">{ id: 'food', x: 20, y: 290 },</span></p>
<p class="p1"><span class="s1">{ id: 'hospital', x: 110, y: 20 },</span></p>
<p class="p1"><span class="s1">{ id: 'study', x: 110, y: 110 },</span></p>
<p class="p1"><span class="s1">{ id: 'stonks', x: 110, y: 200 },</span></p>
<p class="p1"><span class="s1">{ id: 'bank', x: 110, y: 290 }, // æ›¿æ¢ finder ä¸º bank</span></p>
<p class="p1"><span class="s1">{ id: 'finder', x: 200, y: 20 }, // ç§»åŠ¨ finder</span></p>
<p class="p1"><span class="s1">{ id: 'settings', x: 200, y: 110 }, // ç§»åŠ¨ settings</span></p>
<p class="p1"><span class="s1">],</span></p>
<p class="p1"><span class="s1">gameover: false,</span></p>
<p class="p1"><span class="s1">ending: null,</span></p>
<p class="p1"><span class="s1">dailyPaid: false,</span></p>
<p class="p1"><span class="s1">loaded: false</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const [windows, setWindows] = useState({</span></p>
<p class="p1"><span class="s1">chat: { isOpen: false, z: 1, title: "K-Talk", minimized: false },</span></p>
<p class="p1"><span class="s1">browser: { isOpen: true, z: 2, title: "Safari", minimized: false },</span></p>
<p class="p1"><span class="s1">shop: { isOpen: false, z: 3, title: "Amazone", minimized: false },</span></p>
<p class="p1"><span class="s1">bank: { isOpen: false, z: 4, title: "Wallet", minimized: false },</span></p>
<p class="p1"><span class="s1">finder: { isOpen: false, z: 5, title: "Finder", minimized: false },</span></p>
<p class="p1"><span class="s1">food: { isOpen: false, z: 6, title: "é¥±äº†ä¹ˆ", minimized: false },</span></p>
<p class="p1"><span class="s1">hospital: { isOpen: false, z: 7, title: "å¹³å®‰å¥åº·", minimized: false },</span></p>
<p class="p1"><span class="s1">study: { isOpen: false, z: 8, title: "å­¦ä¹ é€š", minimized: false },</span></p>
<p class="p1"><span class="s1">stonks: { isOpen: false, z: 9, title: "Stonks æŠ•èµ„", minimized: false },</span></p>
<p class="p1"><span class="s1">settings: { isOpen: false, z: 10, title: "ç³»ç»Ÿè®¾ç½®", minimized: false },</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const [notifications, setNotifications] = useState([]);</span></p>
<p class="p1"><span class="s1">const [chats, setChats] = useState([</span></p>
<p class="p1"><span class="s1">{ id: 'mom', name: 'å¦ˆå¦ˆ', avatar: 'ğŸ‘©', type: 'mom', msgs: [{ type: 'in', text: 'ç”Ÿæ´»è´¹çœç€ç‚¹èŠ±ï¼Œå¥½å¥½å­¦ä¹ ã€‚' }] },</span></p>
<p class="p1"><span class="s1">{ id: 'agent', name: 'ä¼ åª’æ˜Ÿæ¢', avatar: 'ğŸ•µï¸', type: 'agent', msgs: [{ type: 'in', text: 'æƒ³ä¸æƒ³åˆ©ç”¨è¯¾ä½™æ—¶é—´èµšå¤§é’±ï¼Ÿæˆ‘çœ‹ä½ åº•å­å¾ˆå¥½ã€‚' }] },</span></p>
<p class="p1"><span class="s1">]);</span></p>
<p class="p1"><span class="s1">const [currentChatId, setCurrentChatId] = useState('mom');</span></p>
<p class="p1"><span class="s1">const [posts, setPosts] = useState([]);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- èº«ä»½éªŒè¯å’Œ Firestore åˆå§‹åŒ– ---</span></p>
<p class="p1"><span class="s1">useEffect(() =&gt; {</span></p>
<p class="p1"><span class="s1">if (Object.keys(firebaseConfig).length === 0) return;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">try {</span></p>
<p class="p1"><span class="s1">const app = initializeApp(firebaseConfig);</span></p>
<p class="p1"><span class="s1">const firestoreDb = getFirestore(app);</span></p>
<p class="p1"><span class="s1">const firebaseAuth = getAuth(app);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">setDb(firestoreDb);</span></p>
<p class="p1"><span class="s1">setAuth(firebaseAuth);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (user) =&gt; {</span></p>
<p class="p1"><span class="s1">if (user) {</span></p>
<p class="p1"><span class="s1">setUserId(user.uid);</span></p>
<p class="p1"><span class="s1">} else {</span></p>
<p class="p1"><span class="s1">// å¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œå°è¯•ç™»å½•</span></p>
<p class="p1"><span class="s1">try {</span></p>
<p class="p1"><span class="s1">if (typeof __initial_auth_token !== 'undefined' &amp;&amp; __initial_auth_token) {</span></p>
<p class="p1"><span class="s1">await signInWithCustomToken(firebaseAuth, __initial_auth_token);</span></p>
<p class="p1"><span class="s1">} else {</span></p>
<p class="p1"><span class="s1">await signInAnonymously(firebaseAuth);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">} catch (e) {</span></p>
<p class="p1"><span class="s1">console.error("Firebase ç™»å½•å¤±è´¥:", e);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">setIsAuthReady(true); // æ— è®ºæ˜¯å¦ç™»å½•æˆåŠŸï¼Œauth æµç¨‹å·²å®Œæˆ</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return () =&gt; unsubscribeAuth();</span></p>
<p class="p1"><span class="s1">} catch (e) {</span></p>
<p class="p1"><span class="s1">console.error("Firebase åˆå§‹åŒ–å¤±è´¥:", e);</span></p>
<p class="p1"><span class="s1">setError("Firebase åˆå§‹åŒ–å¤±è´¥ã€‚");</span></p>
<p class="p1"><span class="s1">setDbLoading(false);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}, []);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- Firestore æŠ•èµ„ç»„åˆå®æ—¶ç›‘å¬ ---</span></p>
<p class="p1"><span class="s1">useEffect(() =&gt; {</span></p>
<p class="p1"><span class="s1">if (!db || !userId || !isAuthReady) return;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const portfolioDocRef = doc(db,</span></p>
<p class="p1"><span class="s1">'artifacts', appId,</span></p>
<p class="p1"><span class="s1">'users', userId,</span></p>
<p class="p1"><span class="s1">'portfolio', 'data'</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const unsubscribeSnapshot = onSnapshot(portfolioDocRef, (docSnap) =&gt; {</span></p>
<p class="p1"><span class="s1">if (docSnap.exists()) {</span></p>
<p class="p1"><span class="s1">const data = docSnap.data();</span></p>
<p class="p1"><span class="s1">setPortfolio(prev =&gt; ({</span></p>
<p class="p1"><span class="s1">...DEFAULT_PORTFOLIO,</span></p>
<p class="p1"><span class="s1">...data,</span></p>
<p class="p1"><span class="s1">cash: parseFloat(data.cash || 0),</span></p>
<p class="p1"><span class="s1">stock: parseFloat(data.stock || 0),</span></p>
<p class="p1"><span class="s1">crypto: parseFloat(data.crypto || 0),</span></p>
<p class="p1"><span class="s1">nfts: Array.isArray(data.nfts) ? data.nfts : [],</span></p>
<p class="p1"><span class="s1">history: Array.isArray(data.history) ? data.history : [],</span></p>
<p class="p1"><span class="s1">}));</span></p>
<p class="p1"><span class="s1">setDbLoading(false);</span></p>
<p class="p1"><span class="s1">} else {</span></p>
<p class="p1"><span class="s1">console.log("No portfolio found. Initializing...");</span></p>
<p class="p1"><span class="s1">setDoc(portfolioDocRef, DEFAULT_PORTFOLIO)</span></p>
<p class="p1"><span class="s1">.then(() =&gt; setDbLoading(false))</span></p>
<p class="p1"><span class="s1">.catch(e =&gt; { console.error("Error initializing portfolio:", e); setDbLoading(false); });</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}, (e) =&gt; {</span></p>
<p class="p1"><span class="s1">console.error("Firestore ç›‘å¬å¤±è´¥:", e);</span></p>
<p class="p1"><span class="s1">setError("å®æ—¶æ•°æ®æ›´æ–°å¤±è´¥: " + e.message);</span></p>
<p class="p1"><span class="s1">setDbLoading(false);</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return () =&gt; unsubscribeSnapshot();</span></p>
<p class="p1"><span class="s1">}, [db, userId, appId, isAuthReady]);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- æœ¬åœ°çŠ¶æ€æŒä¹…åŒ– (é Firestore æ•°æ®) ---</span></p>
<p class="p1"><span class="s1">useEffect(() =&gt; {</span></p>
<p class="p1"><span class="s1">const savedLocal = localStorage.getItem('pixelos_local_save');</span></p>
<p class="p1"><span class="s1">if (savedLocal) {</span></p>
<p class="p1"><span class="s1">try {</span></p>
<p class="p1"><span class="s1">const parsed = JSON.parse(savedLocal);</span></p>
<p class="p1"><span class="s1">setGameState(prev =&gt; ({</span></p>
<p class="p1"><span class="s1">...prev,</span></p>
<p class="p1"><span class="s1">...parsed,</span></p>
<p class="p1"><span class="s1">loaded: true,</span></p>
<p class="p1"><span class="s1">inventory: Array.isArray(parsed.inventory) ? parsed.inventory : [],</span></p>
<p class="p1"><span class="s1">gallery: Array.isArray(parsed.gallery) ? parsed.gallery : [],</span></p>
<p class="p1"><span class="s1">icons: Array.isArray(parsed.icons) ? parsed.icons : prev.icons</span></p>
<p class="p1"><span class="s1">}));</span></p>
<p class="p1"><span class="s1">if (parsed.chats) setChats(parsed.chats);</span></p>
<p class="p1"><span class="s1">if (parsed.posts) setPosts(parsed.posts);</span></p>
<p class="p1"><span class="s1">if (parsed.stockPrice) setStockPrice(parsed.stockPrice);</span></p>
<p class="p1"><span class="s1">if (parsed.cryptoPrice) setCryptoPrice(parsed.cryptoPrice);</span></p>
<p class="p1"><span class="s1">} catch (e) { console.error("Load failed", e); }</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}, []);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">useEffect(() =&gt; {</span></p>
<p class="p1"><span class="s1">if (dbLoading || gameState.gameover) return;</span></p>
<p class="p1"><span class="s1">const dataToSave = {</span></p>
<p class="p1"><span class="s1">...gameState,</span></p>
<p class="p1"><span class="s1">posts,</span></p>
<p class="p1"><span class="s1">chats,</span></p>
<p class="p1"><span class="s1">stockPrice,</span></p>
<p class="p1"><span class="s1">cryptoPrice</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p1"><span class="s1">localStorage.setItem('pixelos_local_save', JSON.stringify(dataToSave));</span></p>
<p class="p1"><span class="s1">}, [gameState, posts, chats, stockPrice, cryptoPrice, dbLoading]);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- æ ¸å¿ƒå¾ªç¯å’Œå¸‚åœºæ¨¡æ‹Ÿ ---</span></p>
<p class="p1"><span class="s1">useEffect(() =&gt; {</span></p>
<p class="p1"><span class="s1">if (gameState.gameover) return;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// è‚¡ç¥¨ä»·æ ¼æ¨¡æ‹Ÿ (æ¯ 3 ç§’æ›´æ–°ä¸€æ¬¡)</span></p>
<p class="p1"><span class="s1">const marketInterval = setInterval(() =&gt; {</span></p>
<p class="p1"><span class="s1">setStockPrice(prevPrice =&gt; {</span></p>
<p class="p1"><span class="s1">const change = (Math.random() - 0.5) * 2; // -1 to 1</span></p>
<p class="p1"><span class="s1">return Math.max(10, Math.min(500, prevPrice * (1 + change * 0.01)));</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p1"><span class="s1">setCryptoPrice(prevPrice =&gt; {</span></p>
<p class="p1"><span class="s1">const change = (Math.random() - 0.5) * 4; // -2 to 2</span></p>
<p class="p1"><span class="s1">return Math.max(100, Math.min(5000, prevPrice * (1 + change * 0.02)));</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p1"><span class="s1">}, 3000);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// æ—¶é—´å’Œå¥åº·å¾ªç¯ (æ¯ 5 ç§’æ›´æ–° 30 åˆ†é’Ÿ)</span></p>
<p class="p1"><span class="s1">const gameTimer = setInterval(() =&gt; {</span></p>
<p class="p1"><span class="s1">setGameState(prev =&gt; {</span></p>
<p class="p1"><span class="s1">let newMin = prev.minute + 30;</span></p>
<p class="p1"><span class="s1">let newHour = prev.hour;</span></p>
<p class="p1"><span class="s1">let newDay = prev.day;</span></p>
<p class="p1"><span class="s1">let paid = prev.dailyPaid;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">if (newMin &gt;= 60) {</span></p>
<p class="p1"><span class="s1">newMin = 0;</span></p>
<p class="p1"><span class="s1">newHour += 1;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">if (newHour &gt;= 24) {</span></p>
<p class="p1"><span class="s1">newMin = 0;</span></p>
<p class="p1"><span class="s1">newHour = 8;</span></p>
<p class="p1"><span class="s1">newDay += 1;</span></p>
<p class="p1"><span class="s1">paid = false;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const isSleeping = prev.hour &gt;= 0 &amp;&amp; prev.hour &lt; 8;</span></p>
<p class="p1"><span class="s1">return {</span></p>
<p class="p1"><span class="s1">...prev,</span></p>
<p class="p1"><span class="s1">hour: newHour,</span></p>
<p class="p1"><span class="s1">minute: newMin,</span></p>
<p class="p1"><span class="s1">day: newDay,</span></p>
<p class="p1"><span class="s1">dailyPaid: paid,</span></p>
<p class="p1"><span class="s1">health: isSleeping ? Math.min(100, prev.health + 2) : Math.max(0, prev.health - 0.2),</span></p>
<p class="p1"><span class="s1">academics: Math.max(0, prev.academics - 0.1)</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p1"><span class="s1">}, 5000);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return () =&gt; {</span></p>
<p class="p1"><span class="s1">clearInterval(gameTimer);</span></p>
<p class="p1"><span class="s1">clearInterval(marketInterval);</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p1"><span class="s1">}, [gameState.gameover]);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- äº¤æ˜“å’Œæ•°æ®æ“ä½œå‡½æ•° ---</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const addNotification = (title, msg) =&gt; {</span></p>
<p class="p1"><span class="s1">const id = Date.now() + Math.random();</span></p>
<p class="p1"><span class="s1">setNotifications(prev =&gt; [...prev, { id, title, msg }]);</span></p>
<p class="p1"><span class="s1">setTimeout(() =&gt; setNotifications(prev =&gt; prev.filter(n =&gt; n.id !== id)), 4000);</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const updateGameState = (changes) =&gt; {</span></p>
<p class="p1"><span class="s1">setGameState(prev =&gt; {</span></p>
<p class="p1"><span class="s1">let newHour = prev.hour;</span></p>
<p class="p1"><span class="s1">let newMin = prev.minute;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// å¤„ç†æ—¶é—´</span></p>
<p class="p1"><span class="s1">if (changes.timeCost) {</span></p>
<p class="p1"><span class="s1">newMin += changes.timeCost;</span></p>
<p class="p1"><span class="s1">while (newMin &gt;= 60) {</span></p>
<p class="p1"><span class="s1">newMin -= 60;</span></p>
<p class="p1"><span class="s1">newHour += 1;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">if (newHour &gt;= 24) {</span></p>
<p class="p1"><span class="s1">// æ¨¡æ‹Ÿæ—¶é—´æµé€å¯¼è‡´è·¨å¤© (å¿½ç•¥åˆ†é’Ÿï¼Œç›´æ¥è¿›å…¥ç¬¬äºŒå¤©æ—©ä¸Š8ç‚¹)</span></p>
<p class="p1"><span class="s1">newHour = 8;</span></p>
<p class="p1"><span class="s1">changes.day = (changes.day || 0) + 1;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const next = { ...prev, hour: newHour, minute: newMin };</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">for (const key in changes) {</span></p>
<p class="p1"><span class="s1">if (key === 'timeCost') continue;</span></p>
<p class="p1"><span class="s1">if (typeof changes[key] === 'number' &amp;&amp; key !== 'dailyPaid') {</span></p>
<p class="p1"><span class="s1">next[key] = parseFloat((prev[key] + changes[key]).toFixed(1));</span></p>
<p class="p1"><span class="s1">// é™åˆ¶æ ¸å¿ƒå±æ€§èŒƒå›´</span></p>
<p class="p1"><span class="s1">if (key === 'health' || key === 'sanity' || key === 'academics') {</span></p>
<p class="p1"><span class="s1">next[key] = Math.min(100, Math.max(0, next[key]));</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">} else {</span></p>
<p class="p1"><span class="s1">next[key] = changes[key];</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">return next;</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const deductCash = useCallback(async (cost, actionType) =&gt; {</span></p>
<p class="p1"><span class="s1">if (!db || !userId || dbLoading || cost &lt;= 0) {</span></p>
<p class="p1"><span class="s1">addNotification("ç³»ç»Ÿé”™è¯¯", "æ— æ³•æ‰£é™¤ç°é‡‘ã€‚");</span></p>
<p class="p1"><span class="s1">return false;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const currentCash = portfolio.cash;</span></p>
<p class="p1"><span class="s1">if (currentCash &lt; cost) {</span></p>
<p class="p1"><span class="s1">addNotification("æ“ä½œå¤±è´¥", "ç°é‡‘ä¸è¶³ï¼");</span></p>
<p class="p1"><span class="s1">return false;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const portfolioDocRef = doc(db, 'artifacts', appId, 'users', userId, 'portfolio', 'data');</span></p>
<p class="p1"><span class="s1">const newCash = currentCash - cost;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">try {</span></p>
<p class="p1"><span class="s1">await updateDoc(portfolioDocRef, {</span></p>
<p class="p1"><span class="s1">cash: newCash,</span></p>
<p class="p1"><span class="s1">history: [</span></p>
<p class="p1"><span class="s1">...(portfolio.history || []),</span></p>
<p class="p1"><span class="s1">{</span></p>
<p class="p1"><span class="s1">type: 'expense',</span></p>
<p class="p1"><span class="s1">asset: actionType,</span></p>
<p class="p1"><span class="s1">quantity: 1,</span></p>
<p class="p1"><span class="s1">price: -cost, // Negative price for expense</span></p>
<p class="p1"><span class="s1">timestamp: new Date().toISOString()</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">]</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p1"><span class="s1">return true;</span></p>
<p class="p1"><span class="s1">} catch (e) {</span></p>
<p class="p1"><span class="s1">console.error("Deduct Cash Failed:", e);</span></p>
<p class="p1"><span class="s1">addNotification("ç³»ç»Ÿé”™è¯¯", "æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");</span></p>
<p class="p1"><span class="s1">return false;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}, [db, userId, dbLoading, portfolio, appId, addNotification]);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// ç»Ÿä¸€äº¤æ˜“é€»è¾‘ - ä»…ç”¨äºè‚¡ç¥¨/åŠ å¯†å¸</span></p>
<p class="p1"><span class="s1">const executeTrade = useCallback(async (assetType, action, amount) =&gt; {</span></p>
<p class="p1"><span class="s1">if (!db || !userId || dbLoading || amount &lt;= 0 || !['stock', 'crypto'].includes(assetType)) {</span></p>
<p class="p1"><span class="s1">console.error("Execute Trade Pre-check Failed:", { db, userId, dbLoading, amount, assetType });</span></p>
<p class="p1"><span class="s1">return;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const currentPortfolio = portfolio;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const quantity = parseFloat(amount);</span></p>
<p class="p1"><span class="s1">const price = assetType === 'stock' ? stockPrice : cryptoPrice;</span></p>
<p class="p1"><span class="s1">const cost = quantity * price;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">let newCash = currentPortfolio.cash;</span></p>
<p class="p1"><span class="s1">let newAsset = currentPortfolio[assetType];</span></p>
<p class="p1"><span class="s1">let success = false;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// åˆå§‹åŒ–æ›´æ–°å¯¹è±¡</span></p>
<p class="p1"><span class="s1">let updateFields = {};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">if (action === 'buy') {</span></p>
<p class="p1"><span class="s1">if (newCash &lt; cost) {</span></p>
<p class="p1"><span class="s1">addNotification("äº¤æ˜“å¤±è´¥", "ç°é‡‘ä¸è¶³ï¼Œæ— æ³•è´­ä¹°ï¼");</span></p>
<p class="p1"><span class="s1">} else {</span></p>
<p class="p1"><span class="s1">newCash -= cost;</span></p>
<p class="p1"><span class="s1">newAsset += quantity;</span></p>
<p class="p1"><span class="s1">updateFields = { cash: newCash, [assetType]: newAsset };</span></p>
<p class="p1"><span class="s1">success = true;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">} else if (action === 'sell') {</span></p>
<p class="p1"><span class="s1">if (newAsset &lt; quantity) {</span></p>
<p class="p1"><span class="s1">addNotification("äº¤æ˜“å¤±è´¥", `æŒæœ‰ ${assetType} ä¸è¶³ï¼Œæ— æ³•å–å‡ºï¼`);</span></p>
<p class="p1"><span class="s1">} else {</span></p>
<p class="p1"><span class="s1">newCash += cost;</span></p>
<p class="p1"><span class="s1">newAsset -= quantity;</span></p>
<p class="p1"><span class="s1">updateFields = { cash: newCash, [assetType]: newAsset };</span></p>
<p class="p1"><span class="s1">success = true;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">if (!success) return;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const portfolioDocRef = doc(db,</span></p>
<p class="p1"><span class="s1">'artifacts', appId,</span></p>
<p class="p1"><span class="s1">'users', userId,</span></p>
<p class="p1"><span class="s1">'portfolio', 'data'</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const historyEntry = {</span></p>
<p class="p1"><span class="s1">type: action,</span></p>
<p class="p1"><span class="s1">asset: assetType,</span></p>
<p class="p1"><span class="s1">quantity: quantity,</span></p>
<p class="p1"><span class="s1">price: action === 'buy' ? -cost : cost, // Buy is expense, sell is income</span></p>
<p class="p1"><span class="s1">timestamp: new Date().toISOString()</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">try {</span></p>
<p class="p1"><span class="s1">await updateDoc(portfolioDocRef, {</span></p>
<p class="p1"><span class="s1">...updateFields,</span></p>
<p class="p1"><span class="s1">history: [</span></p>
<p class="p1"><span class="s1">...(currentPortfolio.history || []),</span></p>
<p class="p1"><span class="s1">historyEntry</span></p>
<p class="p1"><span class="s1">]</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p1"><span class="s1">addNotification("äº¤æ˜“æˆåŠŸ", `${action === 'buy' ? 'è´­å…¥' : 'å–å‡º'} ${quantity.toFixed(2)} ä»½ ${assetType.toUpperCase()}ã€‚`);</span></p>
<p class="p1"><span class="s1">} catch (e) {</span></p>
<p class="p1"><span class="s1">console.error("æ›´æ–°æŠ•èµ„ç»„åˆå¤±è´¥:", e);</span></p>
<p class="p1"><span class="s1">addNotification("äº¤æ˜“é”™è¯¯", "æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}, [db, userId, dbLoading, portfolio, stockPrice, cryptoPrice, appId, addNotification]);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// å‘å¸–é€»è¾‘ (ç”Ÿå›¾ + å­˜å›¾)</span></p>
<p class="p1"><span class="s1">const handlePost = async (caption, userPrompt, imageUrl, imageSource, selectedItem) =&gt; {</span></p>
<p class="p1"><span class="s1">updateGameState({ health: -1, hour: imageSource === 'text' ? 0 : 1 });</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">let finalImageSrc = null;</span></p>
<p class="p1"><span class="s1">let finalRisk = 5;</span></p>
<p class="p1"><span class="s1">let finalFans = 10;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">if (imageSource === 'ai' &amp;&amp; userPrompt) {</span></p>
<p class="p1"><span class="s1">addNotification("System", "æ­£åœ¨ç”Ÿæˆå›¾åƒä¸å®¡æ ¸...");</span></p>
<p class="p1"><span class="s1">const imgPrompt = `${userPrompt}, ${selectedItem ? selectedItem.name : ''}, anime style, pixel art aesthetic, cute girl`;</span></p>
<p class="p1"><span class="s1">const imageBase64 = await callImagen(imgPrompt);</span></p>
<p class="p1"><span class="s1">finalImageSrc = imageBase64;</span></p>
<p class="p1"><span class="s1">} else if (imageSource === 'url' &amp;&amp; imageUrl) {</span></p>
<p class="p1"><span class="s1">finalImageSrc = imageUrl;</span></p>
<p class="p1"><span class="s1">} else if (imageSource === 'text') {</span></p>
<p class="p1"><span class="s1">finalImageSrc = null; // çº¯æ–‡å­—å¸–æ–‡</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// å¦‚æœæ˜¯å›¾ç‰‡å¸–æ–‡ä½†å›¾ç‰‡ç”Ÿæˆå¤±è´¥æˆ–ç”¨æˆ·æœªæä¾› URLï¼Œä½¿ç”¨é€šç”¨å ä½å›¾</span></p>
<p class="p1"><span class="s1">if (!finalImageSrc &amp;&amp; imageSource !== 'text') {</span></p>
<p class="p1"><span class="s1">finalImageSrc = `https://placehold.co/400x400/1e293b/f8fafc?text=Image+Placeholder`;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const aiPrompt = `å‘å¸–æ–‡æ¡ˆï¼š${caption}ã€‚ç‰©å“ï¼š${selectedItem ? selectedItem.name : 'æ— '}ã€‚${imageSource === 'text' ? 'çº¯æ–‡å­—å¸–æ–‡ã€‚' : 'å¸¦æœ‰å›¾ç‰‡ã€‚'}ç”ŸæˆJSON: {"risk_score": 0-100, "fans_gain": 0-500, "comments": ["è¯„è®º1", "è¯„è®º2"], "trigger_dm": boolean, "dm_content": "..."}`;</span></p>
<p class="p1"><span class="s1">const result = await callGeminiJson(aiPrompt);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">if (!result) {</span></p>
<p class="p1"><span class="s1">addNotification("Error", "ç½‘ç»œé”™è¯¯ï¼Œå‘å¸ƒå¤±è´¥");</span></p>
<p class="p1"><span class="s1">return;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">finalRisk = imageSource === 'text' ? Math.floor((result.risk_score || 10) / 3) : (result.risk_score || 10);</span></p>
<p class="p1"><span class="s1">finalFans = result.fans_gain || 10;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const newImage = {</span></p>
<p class="p1"><span class="s1">id: Date.now(),</span></p>
<p class="p1"><span class="s1">src: finalImageSrc || 'TEXT',</span></p>
<p class="p1"><span class="s1">prompt: userPrompt || 'N/A',</span></p>
<p class="p1"><span class="s1">risk: finalRisk,</span></p>
<p class="p1"><span class="s1">date: `Day ${gameState.day}`</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">setGameState(prev =&gt; ({</span></p>
<p class="p1"><span class="s1">...prev,</span></p>
<p class="p1"><span class="s1">gallery: (imageSource !== 'text') ? [newImage, ...prev.gallery] : prev.gallery,</span></p>
<p class="p1"><span class="s1">fans: prev.fans + finalFans,</span></p>
<p class="p1"><span class="s1">exposure: prev.exposure + finalRisk / 5,</span></p>
<p class="p1"><span class="s1">sanity: prev.sanity - (finalRisk / 15)</span></p>
<p class="p1"><span class="s1">}));</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const newPost = {</span></p>
<p class="p1"><span class="s1">id: newImage.id,</span></p>
<p class="p1"><span class="s1">desc: caption,</span></p>
<p class="p1"><span class="s1">imgSrc: newImage.src,</span></p>
<p class="p1"><span class="s1">likes: Math.floor(finalFans * 0.8),</span></p>
<p class="p1"><span class="s1">comments: result.comments || [],</span></p>
<p class="p1"><span class="s1">risk: finalRisk</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">setPosts(prev =&gt; [newPost, ...prev]);</span></p>
<p class="p1"><span class="s1">addNotification("SweetGram", `å‘å¸ƒæˆåŠŸï¼ç²‰ä¸ +${finalFans}`);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">if (result.trigger_dm &amp;&amp; result.dm_content) {</span></p>
<p class="p1"><span class="s1">createChat('creep', null, result.dm_content);</span></p>
<p class="p1"><span class="s1">addNotification("K-Talk", "æ”¶åˆ°ä¸€æ¡ç§ä¿¡");</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const createChat = (type, name, initialMsg) =&gt; {</span></p>
<p class="p1"><span class="s1">const id = `user_${Date.now()}`;</span></p>
<p class="p1"><span class="s1">const newChat = {</span></p>
<p class="p1"><span class="s1">id,</span></p>
<p class="p1"><span class="s1">name: name || `User_${id.slice(-4)}`,</span></p>
<p class="p1"><span class="s1">avatar: ['ğŸ‘¨', 'ğŸ¦Š', 'ğŸ·'][Math.floor(Math.random()*3)],</span></p>
<p class="p1"><span class="s1">type: type || 'fan',</span></p>
<p class="p1"><span class="s1">msgs: initialMsg ? [{ type: 'in', text: initialMsg }] : []</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p1"><span class="s1">setChats(prev =&gt; [newChat, ...prev]);</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const handleIconDrag = (id, newX, newY) =&gt; {</span></p>
<p class="p1"><span class="s1">setGameState(prev =&gt; ({</span></p>
<p class="p1"><span class="s1">...prev,</span></p>
<p class="p1"><span class="s1">icons: prev.icons.map(icon =&gt; icon.id === id ? { ...icon, x: newX, y: newY } : icon)</span></p>
<p class="p1"><span class="s1">}));</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- æ¸²æŸ“ ---</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const getWallpaper = () =&gt; {</span></p>
<p class="p1"><span class="s1">const wp = WALLPAPERS.find(w =&gt; w.id === gameState.settings.wallpaper) || WALLPAPERS[0];</span></p>
<p class="p1"><span class="s1">return wp.style;</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const currentCash = portfolio.cash || 0;</span></p>
<p class="p1"><span class="s1">const currentStockValue = (portfolio.stock * stockPrice) || 0;</span></p>
<p class="p1"><span class="s1">const currentCryptoValue = (portfolio.crypto * cryptoPrice) || 0;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">if (error) return &lt;div className="p-4 text-center text-red-600"&gt;é”™è¯¯: {error}&lt;/div&gt;;</span></p>
<p class="p1"><span class="s1">if (!isAuthReady || dbLoading) return &lt;div className="flex items-center justify-center h-screen bg-gray-100"&gt;&lt;Loader className="animate-spin text-indigo-500 mr-3"/&gt; æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...&lt;/div&gt;;</span></p>
<p class="p1"><span class="s1">if (gameState.gameover) return &lt;div className="bg-black text-white h-screen flex items-center justify-center"&gt;GAME OVER&lt;/div&gt;;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className={`w-full h-screen overflow-hidden relative font-sans select-none ${getWallpaper()} text-gray-800 transition-all duration-500`}&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="pointer-events-none absolute inset-0 z-50 bg-[url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAABkCAYAAABHP/WjAAAABmJLR0QA/wD/AP/gvaeTAAAAEElEQVQImWP4//8/MwMjIQAABt0D56LzN2YAAAAASUVORK5CYII=')] opacity-5 mix-blend-overlay"&gt;&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;MenuBar gameState={gameState} currentCash={currentCash} /&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div className="absolute inset-0 top-8 bottom-16"&gt;</span></p>
<p class="p1"><span class="s1">{gameState.icons.map(icon =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;DraggableIcon</span></p>
<p class="p1"><span class="s1">key={icon.id}</span></p>
<p class="p1"><span class="s1">icon={icon}</span></p>
<p class="p1"><span class="s1">onDragEnd={handleIconDrag}</span></p>
<p class="p1"><span class="s1">onClick={() =&gt; setWindows(p =&gt; ({...p, [icon.id]: {...p[icon.id], isOpen: true, z: Date.now()}}))}</span></p>
<p class="p1"><span class="s1">/&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">{Object.entries(windows).map(([key, win]) =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;Window key={key} config={win} onClose={() =&gt; setWindows(p =&gt; ({...p, [key]: {...p[key], isOpen: false}}))}&gt;</span></p>
<p class="p1"><span class="s1">{key === 'browser' &amp;&amp; &lt;BrowserApp gameState={gameState} onPost={handlePost} posts={posts} inventory={gameState.inventory} /&gt;}</span></p>
<p class="p1"><span class="s1">{key === 'chat' &amp;&amp; &lt;ChatApp chats={chats} currentId={currentChatId} onSelect={setCurrentChatId} setChats={setChats} updateState={updateGameState} gameState={gameState} /&gt;}</span></p>
<p class="p1"><span class="s1">{key === 'shop' &amp;&amp; &lt;ShopApp currentCash={currentCash} onBuy={(item) =&gt; {</span></p>
<p class="p1"><span class="s1">if(currentCash &gt;= item.price) {</span></p>
<p class="p1"><span class="s1">deductCash(item.price, 'item_purchase');</span></p>
<p class="p1"><span class="s1">setGameState(p =&gt; ({...p, inventory: [...p.inventory, item]}));</span></p>
<p class="p1"><span class="s1">addNotification("Shop", "è´­ä¹°æˆåŠŸ");</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}} inventory={gameState.inventory} /&gt;}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">{key === 'stonks' &amp;&amp; &lt;StonksApp</span></p>
<p class="p1"><span class="s1">stockPrice={stockPrice}</span></p>
<p class="p1"><span class="s1">cryptoPrice={cryptoPrice}</span></p>
<p class="p1"><span class="s1">portfolio={portfolio}</span></p>
<p class="p1"><span class="s1">executeTrade={executeTrade}</span></p>
<p class="p1"><span class="s1">addNotification={addNotification}</span></p>
<p class="p1"><span class="s1">db={db}</span></p>
<p class="p1"><span class="s1">userId={userId}</span></p>
<p class="p1"><span class="s1">appId={appId}</span></p>
<p class="p1"><span class="s1">/&gt;}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">{key === 'finder' &amp;&amp; &lt;FinderApp gallery={gameState.gallery} /&gt;}</span></p>
<p class="p1"><span class="s1">{key === 'settings' &amp;&amp; &lt;SettingsApp current={gameState.settings} onChange={(s) =&gt; setGameState(p =&gt; ({...p, settings: {...p.settings, ...s}}))} onReset={() =&gt; {localStorage.clear(); window.location.reload();}} /&gt;}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">{key === 'food' &amp;&amp; &lt;FoodApp options={FOOD_OPTIONS} deductCash={deductCash} updateState={updateGameState} currentCash={currentCash} addNotification={addNotification} /&gt;}</span></p>
<p class="p1"><span class="s1">{key === 'hospital' &amp;&amp; &lt;HospitalApp options={HOSPITAL_OPTIONS} deductCash={deductCash} updateState={updateGameState} currentCash={currentCash} addNotification={addNotification} /&gt;}</span></p>
<p class="p1"><span class="s1">{key === 'study' &amp;&amp; &lt;StudyApp options={STUDY_OPTIONS} deductCash={deductCash} updateState={updateGameState} currentCash={currentCash} addNotification={addNotification} /&gt;}</span></p>
<p class="p1"><span class="s1">{key === 'bank' &amp;&amp; &lt;BankApp portfolio={portfolio} /&gt;}</span></p>
<p class="p1"><span class="s1">&lt;/Window&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;Dock windows={windows} setWindows={setWindows} /&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div className="absolute top-10 right-4 flex flex-col gap-2 z-[100]"&gt;</span></p>
<p class="p1"><span class="s1">{notifications.map(n =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;div key={n.id} className="bg-white/90 backdrop-blur shadow-lg rounded p-3 w-64 animate-slide-in text-sm border-l-4 border-blue-500"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="font-bold"&gt;{n.title}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="text-xs text-gray-600"&gt;{n.msg}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- App ç»„ä»¶: FoodApp ---</span></p>
<p class="p1"><span class="s1">function FoodApp({ options, deductCash, updateState, currentCash, addNotification }) {</span></p>
<p class="p1"><span class="s1">const handleAction = async (item) =&gt; {</span></p>
<p class="p1"><span class="s1">const success = await deductCash(item.cost, `food_${item.id}`);</span></p>
<p class="p1"><span class="s1">if (success) {</span></p>
<p class="p1"><span class="s1">updateState({</span></p>
<p class="p1"><span class="s1">health: item.healthGain,</span></p>
<p class="p1"><span class="s1">academics: item.academicsChange,</span></p>
<p class="p1"><span class="s1">timeCost: item.timeCost</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p1"><span class="s1">addNotification("é¥±äº†ä¹ˆ", `äº«ç”¨ ${item.name} æˆåŠŸï¼ä½“åŠ›+${item.healthGain}`);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="h-full bg-gray-50 p-6 overflow-y-auto"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h2 className="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"&gt;&lt;Utensils size={24}/&gt; é¥±äº†ä¹ˆ (å¤–å–)&lt;/h2&gt;</span></p>
<p class="p1"><span class="s1">&lt;p className="text-sm text-gray-600 mb-6"&gt;å½“å‰ç°é‡‘ï¼š&lt;span className="font-mono font-bold text-green-600"&gt;Â¥{currentCash.toFixed(2)}&lt;/span&gt;&lt;/p&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div className="space-y-4"&gt;</span></p>
<p class="p1"><span class="s1">{options.map(item =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;div key={item.id} className="bg-white p-4 rounded-lg shadow flex justify-between items-center border border-gray-200"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="font-bold text-base"&gt;{item.name} &lt;span className="text-xs text-red-500"&gt;Â¥{item.cost}&lt;/span&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;p className="text-xs text-gray-500 mt-1"&gt;</span></p>
<p class="p1"><span class="s1">æ•ˆæœ: ä½“åŠ› +{item.healthGain}, å­¦æœ¯ {item.academicsChange &gt;= 0 ? '+' : ''}{item.academicsChange} | è€—æ—¶: {item.timeCost} åˆ†é’Ÿ</span></p>
<p class="p1"><span class="s1">&lt;/p&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;button</span></p>
<p class="p1"><span class="s1">onClick={() =&gt; handleAction(item)}</span></p>
<p class="p1"><span class="s1">disabled={currentCash &lt; item.cost}</span></p>
<p class="p1"><span class="s1">className={`px-4 py-2 text-sm rounded text-white font-bold transition ${currentCash &lt; item.cost ? 'bg-gray-400' : 'bg-green-500 hover:bg-green-600'}`}</span></p>
<p class="p1"><span class="s1">&gt;</span></p>
<p class="p1"><span class="s1">{currentCash &lt; item.cost ? 'ç°é‡‘ä¸è¶³' : 'ä¸‹å•'}</span></p>
<p class="p1"><span class="s1">&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="mt-6 text-xs text-gray-500 p-2 border-t"&gt;åƒé¥­å¯ä»¥æ¢å¤ä½“åŠ›ï¼Œä½†ä¼šæ¶ˆè€—æ—¶é—´ï¼Œä¸å¥åº·çš„é£Ÿç‰©è¿˜ä¼šå½±å“å­¦ä¹ çŠ¶æ€ã€‚&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- App ç»„ä»¶: HospitalApp ---</span></p>
<p class="p1"><span class="s1">function HospitalApp({ options, deductCash, updateState, currentCash, addNotification }) {</span></p>
<p class="p1"><span class="s1">const handleAction = async (item) =&gt; {</span></p>
<p class="p1"><span class="s1">const success = await deductCash(item.cost, `health_${item.id}`);</span></p>
<p class="p1"><span class="s1">if (success) {</span></p>
<p class="p1"><span class="s1">updateState({</span></p>
<p class="p1"><span class="s1">health: item.healthGain,</span></p>
<p class="p1"><span class="s1">sanity: item.sanityGain,</span></p>
<p class="p1"><span class="s1">exposure: item.exposureRisk,</span></p>
<p class="p1"><span class="s1">timeCost: item.timeCost</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p1"><span class="s1">addNotification("å¹³å®‰å¥åº·", `${item.name} å®Œæˆã€‚å¥åº·+${item.healthGain}ï¼Œç²¾ç¥+${item.sanityGain}`);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="h-full bg-gray-50 p-6 overflow-y-auto"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h2 className="text-2xl font-bold text-red-700 mb-4 flex items-center gap-2"&gt;&lt;Stethoscope size={24}/&gt; å¹³å®‰å¥åº· (åŒ»ç–—)&lt;/h2&gt;</span></p>
<p class="p1"><span class="s1">&lt;p className="text-sm text-gray-600 mb-6"&gt;å½“å‰ç°é‡‘ï¼š&lt;span className="font-mono font-bold text-green-600"&gt;Â¥{currentCash.toFixed(2)}&lt;/span&gt;&lt;/p&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div className="space-y-4"&gt;</span></p>
<p class="p1"><span class="s1">{options.map(item =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;div key={item.id} className="bg-white p-4 rounded-lg shadow flex justify-between items-center border border-gray-200"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="font-bold text-base"&gt;{item.name} &lt;span className="text-xs text-red-500"&gt;Â¥{item.cost}&lt;/span&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;p className="text-xs text-gray-500 mt-1"&gt;</span></p>
<p class="p1"><span class="s1">æ•ˆæœ: ä½“åŠ› +{item.healthGain}, ç²¾ç¥ +{item.sanityGain} | é£é™©: {item.exposureRisk} æ›å…‰ | è€—æ—¶: {item.timeCost} åˆ†é’Ÿ</span></p>
<p class="p1"><span class="s1">&lt;/p&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;button</span></p>
<p class="p1"><span class="s1">onClick={() =&gt; handleAction(item)}</span></p>
<p class="p1"><span class="s1">disabled={currentCash &lt; item.cost}</span></p>
<p class="p1"><span class="s1">className={`px-4 py-2 text-sm rounded text-white font-bold transition ${currentCash &lt; item.cost ? 'bg-gray-400' : 'bg-red-500 hover:bg-red-600'}`}</span></p>
<p class="p1"><span class="s1">&gt;</span></p>
<p class="p1"><span class="s1">{currentCash &lt; item.cost ? 'ç°é‡‘ä¸è¶³' : 'ç«‹å³å°±è¯Š'}</span></p>
<p class="p1"><span class="s1">&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="mt-6 text-xs text-gray-500 p-2 border-t"&gt;é«˜é£é™©æ“ä½œï¼ˆå¦‚æ•´å½¢ï¼‰èƒ½æ˜¾è‘—æ”¹å–„çŠ¶æ€ï¼Œä½†ä¼šå¢åŠ æ›å…‰åº¦ã€‚&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- App ç»„ä»¶: StudyApp ---</span></p>
<p class="p1"><span class="s1">function StudyApp({ options, deductCash, updateState, currentCash, addNotification }) {</span></p>
<p class="p1"><span class="s1">const handleAction = async (item) =&gt; {</span></p>
<p class="p1"><span class="s1">let success = true;</span></p>
<p class="p1"><span class="s1">if (item.cashCost &gt; 0) {</span></p>
<p class="p1"><span class="s1">success = await deductCash(item.cashCost, `study_${item.id}`);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">if (success) {</span></p>
<p class="p1"><span class="s1">updateState({</span></p>
<p class="p1"><span class="s1">academics: item.academicsGain,</span></p>
<p class="p1"><span class="s1">health: -2, // å­¦ä¹ æ¶ˆè€—ä½“åŠ›</span></p>
<p class="p1"><span class="s1">timeCost: item.timeCost</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p1"><span class="s1">addNotification("å­¦ä¹ é€š", `å®Œæˆ ${item.name}ï¼å­¦æœ¯+${item.academicsGain}`);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="h-full bg-gray-50 p-6 overflow-y-auto"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h2 className="text-2xl font-bold text-purple-700 mb-4 flex items-center gap-2"&gt;&lt;GraduationCap size={24}/&gt; å­¦ä¹ é€š (å­¦æœ¯)&lt;/h2&gt;</span></p>
<p class="p1"><span class="s1">&lt;p className="text-sm text-gray-600 mb-6"&gt;å½“å‰ç°é‡‘ï¼š&lt;span className="font-mono font-bold text-green-600"&gt;Â¥{currentCash.toFixed(2)}&lt;/span&gt;&lt;/p&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div className="space-y-4"&gt;</span></p>
<p class="p1"><span class="s1">{options.map(item =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;div key={item.id} className="bg-white p-4 rounded-lg shadow flex justify-between items-center border border-gray-200"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="font-bold text-base"&gt;{item.name} &lt;span className="text-xs text-red-500"&gt;{item.cashCost &gt; 0 ? `Â¥${item.cashCost}` : 'å…è´¹'}&lt;/span&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;p className="text-xs text-gray-500 mt-1"&gt;</span></p>
<p class="p1"><span class="s1">æ•ˆæœ: å­¦æœ¯ +{item.academicsGain}, ä½“åŠ› -2 | è€—æ—¶: {item.timeCost} åˆ†é’Ÿ</span></p>
<p class="p1"><span class="s1">&lt;/p&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;button</span></p>
<p class="p1"><span class="s1">onClick={() =&gt; handleAction(item)}</span></p>
<p class="p1"><span class="s1">disabled={currentCash &lt; item.cashCost}</span></p>
<p class="p1"><span class="s1">className={`px-4 py-2 text-sm rounded text-white font-bold transition ${currentCash &lt; item.cashCost ? 'bg-gray-400' : 'bg-purple-500 hover:bg-purple-600'}`}</span></p>
<p class="p1"><span class="s1">&gt;</span></p>
<p class="p1"><span class="s1">{currentCash &lt; item.cashCost ? 'ç°é‡‘ä¸è¶³' : 'å¼€å§‹å­¦ä¹ '}</span></p>
<p class="p1"><span class="s1">&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="mt-6 text-xs text-gray-500 p-2 border-t"&gt;ä¿æŒé«˜å­¦æœ¯æ°´å¹³æ˜¯å¹³è¡¡ç”Ÿæ´»çš„å…³é”®ï¼Œä½†è¦è­¦æƒ•å­¦ä¹ æ—¶é—´è¿‡é•¿å¯¼è‡´çš„ç–²åŠ³ã€‚&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- App ç»„ä»¶: BankApp ---</span></p>
<p class="p1"><span class="s1">function BankApp({ portfolio }) {</span></p>
<p class="p1"><span class="s1">const formatCurrency = (amount) =&gt; (parseFloat(amount) || 0).toFixed(2);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// å‡è®¾ portfolio.history æ˜¯æœ€æ–°çš„</span></p>
<p class="p1"><span class="s1">const history = portfolio.history.slice().reverse(); // åè½¬ï¼Œæœ€æ–°åœ¨æœ€å‰</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="h-full bg-gray-50 p-6 flex flex-col"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h2 className="text-2xl font-bold text-blue-700 mb-4 flex items-center gap-2"&gt;&lt;DollarSign size={24}/&gt; Wallet (é’±åŒ…)&lt;/h2&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div className="bg-white p-4 rounded-lg shadow-md mb-4 border-l-4 border-blue-500"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="text-sm text-gray-500"&gt;æ€»èµ„äº§ (ç°é‡‘ + æŠ•èµ„)&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="text-4xl font-mono font-extrabold text-blue-700"&gt;Â¥{formatCurrency(portfolio.cash + (portfolio.stock * 100) + (portfolio.crypto * 500))}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="text-xs text-gray-500 mt-2"&gt;ç°é‡‘ä½™é¢: &lt;span className="font-bold"&gt;Â¥{formatCurrency(portfolio.cash)}&lt;/span&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;h3 className="text-lg font-bold text-gray-700 mb-2 border-b pb-1"&gt;æœ€è¿‘äº¤æ˜“è®°å½•&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex-1 overflow-y-auto space-y-2 text-sm pr-2"&gt;</span></p>
<p class="p1"><span class="s1">{history.length &gt; 0 ? (</span></p>
<p class="p1"><span class="s1">history.map((tx, index) =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;div key={index} className={`flex justify-between items-center p-2 rounded ${tx.price &gt; 0 ? 'bg-green-100/50' : 'bg-red-100/50'}`}&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex flex-col"&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="font-semibold capitalize"&gt;</span></p>
<p class="p1"><span class="s1">{tx.type === 'buy' ? 'è´­ä¹°' : tx.type === 'sell' ? 'å‡ºå”®' : tx.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'} - {tx.asset}</span></p>
<p class="p1"><span class="s1">&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="text-xs text-gray-500"&gt;{new Date(tx.timestamp).toLocaleTimeString()}&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className={`font-mono font-bold ${tx.price &gt; 0 ? 'text-green-600' : 'text-red-600'}`}&gt;</span></p>
<p class="p1"><span class="s1">{tx.price &gt; 0 ? '+' : ''}Â¥{formatCurrency(Math.abs(tx.price))}</span></p>
<p class="p1"><span class="s1">&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">))</span></p>
<p class="p1"><span class="s1">) : (</span></p>
<p class="p1"><span class="s1">&lt;div className="text-center text-gray-400 mt-4"&gt;æš‚æ— äº¤æ˜“è®°å½•&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">)}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- App ç»„ä»¶: ChatApp (é›†æˆ Gemini API) ---</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function ChatApp({ chats, currentId, onSelect, setChats, updateState, gameState }) {</span></p>
<p class="p1"><span class="s1">const activeChat = chats.find(c =&gt; c.id === currentId) || chats[0];</span></p>
<p class="p1"><span class="s1">const [input, setInput] = useState("");</span></p>
<p class="p1"><span class="s1">const [showGallery, setShowGallery] = useState(false);</span></p>
<p class="p1"><span class="s1">const [isTyping, setIsTyping] = useState(false); // æ–°å¢çŠ¶æ€</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const scrollRef = useRef(null);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// æ»šåŠ¨åˆ°åº•éƒ¨</span></p>
<p class="p1"><span class="s1">useEffect(() =&gt; {</span></p>
<p class="p1"><span class="s1">if (scrollRef.current) {</span></p>
<p class="p1"><span class="s1">scrollRef.current.scrollTop = scrollRef.current.scrollHeight;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}, [activeChat]);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const send = (txt = input, type = 'text', payload = null) =&gt; {</span></p>
<p class="p1"><span class="s1">if (!txt &amp;&amp; type === 'text') return;</span></p>
<p class="p1"><span class="s1">const newMsg = { type: 'out', text: txt, contentType: type, content: payload };</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// 1. å‘é€æ¶ˆæ¯åˆ°æœ¬åœ° UI</span></p>
<p class="p1"><span class="s1">setChats(prev =&gt; prev.map(c =&gt; c.id === activeChat.id ? { ...c, msgs: [...c.msgs, newMsg] } : c));</span></p>
<p class="p1"><span class="s1">setInput("");</span></p>
<p class="p1"><span class="s1">setShowGallery(false);</span></p>
<p class="p1"><span class="s1">setIsTyping(true); // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// 2. è°ƒç”¨ Gemini API è·å–å›å¤</span></p>
<p class="p1"><span class="s1">setTimeout(async () =&gt; {</span></p>
<p class="p1"><span class="s1">const prompt = `ä½ å’Œç©å®¶æ­£åœ¨K-TalkèŠå¤©ã€‚ç©å®¶å‘äº†${type === 'image' ? 'ä¸€å¼ ç…§ç‰‡' : 'æ¶ˆæ¯: '+txt}ã€‚ä½ çš„è§’è‰²å’Œè¯´è¯é£æ ¼æ˜¯ï¼š${NPC_PERSONAS[activeChat.type] || "ä½ æ˜¯ä¸€ä¸ªæ™®é€šçš„ç²‰ä¸ï¼Œå‹å¥½å›å¤ã€‚"}`;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// ä½¿ç”¨æ–°çš„ callGeminiText å‡½æ•°è·å–çº¯æ–‡æœ¬å›å¤</span></p>
<p class="p1"><span class="s1">const resText = await callGeminiText(prompt, `è¯·ä¸¥æ ¼æ‰®æ¼”ä¸€ä¸ª${activeChat.name}ï¼ˆè§’è‰²ç±»å‹ï¼š${activeChat.type}ï¼‰ï¼Œç”¨ä¸­æ–‡å›å¤ç©å®¶çš„æ¶ˆæ¯ã€‚ä¸è¦é€éœ²ä½ æ˜¯ä¸€ä¸ªAIæ¨¡å‹ã€‚`);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">setIsTyping(false); // éšè—æ­£åœ¨è¾“å…¥</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">if (resText) {</span></p>
<p class="p1"><span class="s1">// 3. å°†å›å¤æ·»åŠ åˆ°æœ¬åœ° UI</span></p>
<p class="p1"><span class="s1">setChats(prev =&gt; prev.map(c =&gt; c.id === activeChat.id ? { ...c, msgs: [...c.msgs, { type: 'in', text: resText }] } : c));</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">}, 1500); // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿå’Œæ€è€ƒæ—¶é—´</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="flex h-full bg-white"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="w-1/3 border-r bg-gray-50 overflow-y-auto"&gt;</span></p>
<p class="p1"><span class="s1">{chats.map(c =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;div key={c.id} onClick={() =&gt; onSelect(c.id)} className={`p-3 border-b cursor-pointer hover:bg-gray-100 ${c.id === currentId ? 'bg-blue-50' : ''}`}&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="text-xl"&gt;{c.avatar}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex-1 min-w-0"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="font-bold text-sm truncate"&gt;{c.name}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="text-xs text-gray-500 truncate"&gt;{c.msgs[c.msgs.length-1]?.text || '[å›¾ç‰‡]'}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex-1 flex flex-col relative"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="p-3 border-b font-bold flex justify-between"&gt;</span></p>
<p class="p1"><span class="s1">{activeChat.name}</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; setShowGallery(!showGallery)} className="text-gray-500 hover:text-blue-500"&gt;&lt;ImgIcon size={20}/&gt;&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">{/* èŠå¤©è®°å½•åŒº */}</span></p>
<p class="p1"><span class="s1">&lt;div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-3 bg-[#f2f2f2]"&gt;</span></p>
<p class="p1"><span class="s1">{activeChat.msgs.map((m, i) =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;div key={i} className={`flex ${m.type === 'out' ? 'justify-end' : ''}`}&gt;</span></p>
<p class="p1"><span class="s1">{m.contentType === 'image' ? (</span></p>
<p class="p1"><span class="s1">&lt;div className="max-w-[60%] border-4 border-green-500 rounded-lg overflow-hidden"&gt;</span></p>
<p class="p1"><span class="s1">&lt;img src={m.content} alt="Sent" className="w-full" /&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">) : (</span></p>
<p class="p1"><span class="s1">&lt;div className={`p-2 max-w-[80%] rounded-xl text-sm break-words ${m.type === 'out' ? 'bg-green-500 text-white shadow-md' : 'bg-white border shadow-sm'}`}&gt;{m.text}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">)}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">{/* æ­£åœ¨è¾“å…¥æç¤º */}</span></p>
<p class="p1"><span class="s1">{isTyping &amp;&amp; activeChat.type !== 'mom' &amp;&amp; (</span></p>
<p class="p1"><span class="s1">&lt;div className="flex justify-start"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="p-2 max-w-[80%] rounded-xl text-sm bg-white border shadow-sm flex items-center"&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="text-xs text-gray-400 mr-2"&gt;{activeChat.name} æ­£åœ¨è¾“å…¥&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="w-1 h-1 bg-gray-500 rounded-full animate-bounce delay-100"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="w-1 h-1 bg-gray-500 rounded-full animate-bounce delay-200 ml-1"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="w-1 h-1 bg-gray-500 rounded-full animate-bounce delay-300 ml-1"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">)}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">{/* ç›¸å†Œå‘é€åŒº */}</span></p>
<p class="p1"><span class="s1">{showGallery &amp;&amp; (</span></p>
<p class="p1"><span class="s1">&lt;div className="absolute bottom-12 left-0 right-0 h-40 bg-white border-t shadow-lg overflow-x-auto p-2 flex gap-2 z-10"&gt;</span></p>
<p class="p1"><span class="s1">{gameState.gallery.map(img =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;img</span></p>
<p class="p1"><span class="s1">key={img.id} src={img.src} alt="Gallery"</span></p>
<p class="p1"><span class="s1">className="h-full w-auto object-cover cursor-pointer hover:opacity-80 border-2 border-transparent hover:border-blue-500"</span></p>
<p class="p1"><span class="s1">onClick={() =&gt; send("æˆ‘ç»™ä½ å‘äº†ä¸€å¼ è‡ªæ‹ç…§ï¼Œä½ è§‰å¾—æ€ä¹ˆæ ·ï¼Ÿ", 'image', img.src)}</span></p>
<p class="p1"><span class="s1">/&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">{gameState.gallery.length === 0 &amp;&amp; &lt;div className="text-gray-400 m-auto"&gt;ç›¸å†Œä¸ºç©º&lt;/div&gt;}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">)}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">{/* è¾“å…¥æ¡† */}</span></p>
<p class="p1"><span class="s1">&lt;div className="p-2 border-t flex gap-2"&gt;</span></p>
<p class="p1"><span class="s1">&lt;input className="flex-1 border rounded-full px-4 text-sm focus:ring-2 focus:ring-blue-400 transition" value={input} onChange={e =&gt; setInput(e.target.value)} onKeyDown={e =&gt; e.key === 'Enter' &amp;&amp; send()}/&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; send()} className="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-blue-600 transition disabled:opacity-50" disabled={isTyping}&gt;</span></p>
<p class="p1"><span class="s1">&lt;Send size={16}/&gt;</span></p>
<p class="p1"><span class="s1">&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// --- App ç»„ä»¶: StonksApp (æœªä¿®æ”¹) ---</span></p>
<p class="p1"><span class="s1">function StonksApp({ stockPrice, cryptoPrice, portfolio, executeTrade, addNotification, db, userId, appId }) {</span></p>
<p class="p1"><span class="s1">const { cash, stock, crypto, nfts } = portfolio;</span></p>
<p class="p1"><span class="s1">const [amount, setAmount] = useState(1); // é»˜è®¤äº¤æ˜“æ•°é‡ 1</span></p>
<p class="p1"><span class="s1">const [assetType, setAssetType] = useState('stock'); // é»˜è®¤è‚¡ç¥¨</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const handleInvest = (action) =&gt; {</span></p>
<p class="p1"><span class="s1">executeTrade(assetType, action, amount);</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const mintNFT = async () =&gt; {</span></p>
<p class="p1"><span class="s1">const cost = 500;</span></p>
<p class="p1"><span class="s1">if (!db || !userId || cash &lt; cost) {</span></p>
<p class="p1"><span class="s1">addNotification("äº¤æ˜“å¤±è´¥", "ç°é‡‘ä¸è¶³æˆ–ç³»ç»Ÿæœªå°±ç»ªï¼");</span></p>
<p class="p1"><span class="s1">return;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const value = 100 + (portfolio.cash * 0.05); // åŸºäºç°é‡‘ä¼°å€¼</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const portfolioDocRef = doc(db, 'artifacts', appId, 'users', userId, 'portfolio', 'data');</span></p>
<p class="p1"><span class="s1">const newCash = cash - cost;</span></p>
<p class="p1"><span class="s1">const newNFT = { id: Date.now(), value, initialCost: cost };</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">try {</span></p>
<p class="p1"><span class="s1">await updateDoc(portfolioDocRef, {</span></p>
<p class="p1"><span class="s1">cash: newCash,</span></p>
<p class="p1"><span class="s1">nfts: [...nfts, newNFT],</span></p>
<p class="p1"><span class="s1">history: [</span></p>
<p class="p1"><span class="s1">...(portfolio.history || []),</span></p>
<p class="p1"><span class="s1">{</span></p>
<p class="p1"><span class="s1">type: 'buy',</span></p>
<p class="p1"><span class="s1">asset: 'nft',</span></p>
<p class="p1"><span class="s1">quantity: 1,</span></p>
<p class="p1"><span class="s1">price: -cost,</span></p>
<p class="p1"><span class="s1">timestamp: new Date().toISOString()</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">]</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p1"><span class="s1">addNotification("NFT é“¸é€ æˆåŠŸ", `é“¸é€ æˆæœ¬ Â¥${cost}ï¼Œä¼°å€¼ Â¥${value.toFixed(0)}`);</span></p>
<p class="p1"><span class="s1">} catch (e) {</span></p>
<p class="p1"><span class="s1">console.error("é“¸é€  NFT å¤±è´¥:", e);</span></p>
<p class="p1"><span class="s1">addNotification("äº¤æ˜“é”™è¯¯", "NFT é“¸é€ å¤±è´¥ã€‚");</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const sellNFT = async (id, value) =&gt; {</span></p>
<p class="p1"><span class="s1">if (!db || !userId) {</span></p>
<p class="p1"><span class="s1">addNotification("äº¤æ˜“å¤±è´¥", "ç³»ç»Ÿæœªå°±ç»ªï¼");</span></p>
<p class="p1"><span class="s1">return;</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const sellPrice = value * (0.8 + Math.random() * 0.4); // éšæœºæµ®åŠ¨</span></p>
<p class="p1"><span class="s1">const newCash = cash + sellPrice;</span></p>
<p class="p1"><span class="s1">const newNFTs = nfts.filter(n =&gt; n.id !== id);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const portfolioDocRef = doc(db, 'artifacts', appId, 'users', userId, 'portfolio', 'data');</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">try {</span></p>
<p class="p1"><span class="s1">await updateDoc(portfolioDocRef, {</span></p>
<p class="p1"><span class="s1">cash: newCash,</span></p>
<p class="p1"><span class="s1">nfts: newNFTs,</span></p>
<p class="p1"><span class="s1">history: [</span></p>
<p class="p1"><span class="s1">...(portfolio.history || []),</span></p>
<p class="p1"><span class="s1">{</span></p>
<p class="p1"><span class="s1">type: 'sell',</span></p>
<p class="p1"><span class="s1">asset: 'nft',</span></p>
<p class="p1"><span class="s1">quantity: 1,</span></p>
<p class="p1"><span class="s1">price: sellPrice,</span></p>
<p class="p1"><span class="s1">timestamp: new Date().toISOString()</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">]</span></p>
<p class="p1"><span class="s1">});</span></p>
<p class="p1"><span class="s1">addNotification("å‡ºå”®æˆåŠŸ", `NFT å·²ä»¥ Â¥${sellPrice.toFixed(2)} çš„ä»·æ ¼å–å‡ºã€‚`);</span></p>
<p class="p1"><span class="s1">} catch (e) {</span></p>
<p class="p1"><span class="s1">console.error("å‡ºå”® NFT å¤±è´¥:", e);</span></p>
<p class="p1"><span class="s1">addNotification("äº¤æ˜“é”™è¯¯", "NFT å‡ºå”®å¤±è´¥ã€‚");</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const formatCurrency = (amount) =&gt; (parseFloat(amount) || 0).toFixed(2);</span></p>
<p class="p1"><span class="s1">const stockChange = stockPrice &gt; 100 ? (stockPrice / 100 - 1) : -(1 - stockPrice / 100);</span></p>
<p class="p1"><span class="s1">const cryptoChange = cryptoPrice &gt; 500 ? (cryptoPrice / 500 - 1) : -(1 - cryptoPrice / 500);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="flex flex-col h-full bg-gray-900 text-green-400 font-mono p-4 overflow-y-auto"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="grid grid-cols-2 gap-4 mb-6"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="border border-green-800 p-4 rounded bg-black"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h3 className="text-white text-sm"&gt;è‚¡ç¥¨ (STOCK)&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="text-2xl font-bold"&gt;Â¥{formatCurrency(stockPrice)}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className={stockChange &gt;= 0 ? "text-green-500" : "text-red-500"}&gt;</span></p>
<p class="p1"><span class="s1">{stockChange &gt;= 0 ? '+' : ''}{(stockChange * 100).toFixed(2)}%</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="border border-green-800 p-4 rounded bg-black"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h3 className="text-white text-sm"&gt;åŠ å¯†å¸ (CRYPTO)&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="text-2xl font-bold"&gt;Â¥{formatCurrency(cryptoPrice)}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className={cryptoChange &gt;= 0 ? "text-green-500" : "text-red-500"}&gt;</span></p>
<p class="p1"><span class="s1">{cryptoChange &gt;= 0 ? '+' : ''}{(cryptoChange * 100).toFixed(2)}%</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div className="mb-6 bg-gray-800 p-4 rounded text-white"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h3 className="border-b border-gray-600 mb-2 pb-1"&gt;äº¤æ˜“æ“ä½œ&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex gap-2 mb-4"&gt;</span></p>
<p class="p1"><span class="s1">&lt;select</span></p>
<p class="p1"><span class="s1">className="bg-gray-700 p-2 text-white text-sm rounded"</span></p>
<p class="p1"><span class="s1">value={assetType}</span></p>
<p class="p1"><span class="s1">onChange={e =&gt; setAssetType(e.target.value)}</span></p>
<p class="p1"><span class="s1">&gt;</span></p>
<p class="p1"><span class="s1">&lt;option value="stock"&gt;è‚¡ç¥¨&lt;/option&gt;</span></p>
<p class="p1"><span class="s1">&lt;option value="crypto"&gt;åŠ å¯†å¸&lt;/option&gt;</span></p>
<p class="p1"><span class="s1">&lt;/select&gt;</span></p>
<p class="p1"><span class="s1">&lt;input</span></p>
<p class="p1"><span class="s1">type="number"</span></p>
<p class="p1"><span class="s1">placeholder="æ•°é‡"</span></p>
<p class="p1"><span class="s1">className="bg-gray-700 p-2 text-white w-20 text-sm rounded"</span></p>
<p class="p1"><span class="s1">value={amount}</span></p>
<p class="p1"><span class="s1">onChange={e =&gt; setAmount(Math.max(1, parseInt(e.target.value) || 0))}</span></p>
<p class="p1"><span class="s1">/&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex gap-2"&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; handleInvest('buy')} className="flex-1 bg-green-700 px-3 py-2 rounded hover:bg-green-600 disabled:opacity-50" disabled={cash &lt; amount * (assetType === 'stock' ? stockPrice : cryptoPrice)}&gt;ä¹°å…¥&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; handleInvest('sell')} className="flex-1 bg-red-700 px-3 py-2 rounded hover:bg-red-600 disabled:opacity-50" disabled={portfolio[assetType] &lt; amount}&gt;å–å‡º&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="mt-2 text-xs text-gray-400"&gt;</span></p>
<p class="p1"><span class="s1">æŒæœ‰: è‚¡ç¥¨ {formatCurrency(stock)} ä»½ | åŠ å¯†å¸ {formatCurrency(crypto)} ä»½</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div className="border-t border-gray-700 pt-4"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h3 className="text-white mb-2 flex justify-between items-center"&gt;</span></p>
<p class="p1"><span class="s1">&lt;span&gt;NFT è—å“&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={mintNFT} className="text-xs bg-purple-600 text-white px-2 py-1 rounded disabled:opacity-50" disabled={cash &lt; 500}&gt;é“¸é€ æ–°NFT (Â¥500)&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="grid grid-cols-3 gap-2"&gt;</span></p>
<p class="p1"><span class="s1">{nfts.map(nft =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;div key={nft.id} className="bg-gray-800 p-2 rounded border border-purple-500/50 flex flex-col items-center"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="w-8 h-8 bg-gradient-to-tr from-purple-400 to-pink-500 rounded mb-1"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="text-xs text-white"&gt;Est. Â¥{formatCurrency(nft.value)}&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; sellNFT(nft.id, nft.value)} className="mt-1 text-[10px] bg-blue-600 text-white px-2 rounded"&gt;å‡ºå”®&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">{nfts.length === 0 &amp;&amp; &lt;span className="text-xs text-gray-500 col-span-3 text-center"&gt;æš‚æ— è—å“&lt;/span&gt;}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">// ... (ä¿ç•™å…¶ä»–æœªä¿®æ”¹çš„è¾…åŠ©ç»„ä»¶)</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function DraggableIcon({ icon, onDragEnd, onClick }) {</span></p>
<p class="p1"><span class="s1">const [pos, setPos] = useState({ x: icon.x, y: icon.y });</span></p>
<p class="p1"><span class="s1">const [dragging, setDragging] = useState(false);</span></p>
<p class="p1"><span class="s1">const offset = useRef({ x: 0, y: 0 });</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const handleMouseDown = (e) =&gt; {</span></p>
<p class="p1"><span class="s1">offset.current = { x: e.clientX - pos.x, y: e.clientY - pos.y };</span></p>
<p class="p1"><span class="s1">setDragging(true);</span></p>
<p class="p1"><span class="s1">e.preventDefault();</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const handleMouseMove = (e) =&gt; {</span></p>
<p class="p1"><span class="s1">if (dragging) {</span></p>
<p class="p1"><span class="s1">setPos({ x: e.clientX - offset.current.x, y: e.clientY - offset.current.y });</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const handleMouseUp = () =&gt; {</span></p>
<p class="p1"><span class="s1">if (dragging) {</span></p>
<p class="p1"><span class="s1">setDragging(false);</span></p>
<p class="p1"><span class="s1">onDragEnd(icon.id, pos.x, pos.y);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">useEffect(() =&gt; {</span></p>
<p class="p1"><span class="s1">if (dragging) {</span></p>
<p class="p1"><span class="s1">window.addEventListener('mousemove', handleMouseMove);</span></p>
<p class="p1"><span class="s1">window.addEventListener('mouseup', handleMouseUp);</span></p>
<p class="p1"><span class="s1">} else {</span></p>
<p class="p1"><span class="s1">window.removeEventListener('mousemove', handleMouseMove);</span></p>
<p class="p1"><span class="s1">window.removeEventListener('mouseup', handleMouseUp);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">return () =&gt; {</span></p>
<p class="p1"><span class="s1">window.removeEventListener('mousemove', handleMouseMove);</span></p>
<p class="p1"><span class="s1">window.removeEventListener('mouseup', handleMouseUp);</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p1"><span class="s1">}, [dragging]);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const icons = {</span></p>
<p class="p1"><span class="s1">browser: &lt;Globe className="text-blue-500"/&gt;,</span></p>
<p class="p1"><span class="s1">chat: &lt;MessageCircle className="text-green-500"/&gt;,</span></p>
<p class="p1"><span class="s1">shop: &lt;ShoppingBag className="text-orange-500"/&gt;,</span></p>
<p class="p1"><span class="s1">food: &lt;Utensils className="text-yellow-500"/&gt;,</span></p>
<p class="p1"><span class="s1">hospital: &lt;Stethoscope className="text-red-500"/&gt;,</span></p>
<p class="p1"><span class="s1">study: &lt;GraduationCap className="text-purple-500"/&gt;,</span></p>
<p class="p1"><span class="s1">stonks: &lt;TrendingUp className="text-green-600"/&gt;,</span></p>
<p class="p1"><span class="s1">finder: &lt;Square className="text-gray-500 fill-blue-400"/&gt;,</span></p>
<p class="p1"><span class="s1">settings: &lt;Settings className="text-gray-600"/&gt;,</span></p>
<p class="p1"><span class="s1">bank: &lt;DollarSign className="text-yellow-600"/&gt;</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const labels = {</span></p>
<p class="p1"><span class="s1">browser: "Safari", chat: "K-Talk", shop: "Amazone", food: "é¥±äº†ä¹ˆ",</span></p>
<p class="p1"><span class="s1">hospital: "å¹³å®‰å¥åº·", study: "å­¦ä¹ é€š", stonks: "Stonks", finder: "Finder", settings: "è®¾ç½®", bank: "Wallet"</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const clickStartRef = useRef(0);</span></p>
<p class="p1"><span class="s1">const handleIconClick = (e) =&gt; {</span></p>
<p class="p1"><span class="s1">if (Date.now() - clickStartRef.current &lt; 200) {</span></p>
<p class="p1"><span class="s1">onClick();</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">e.stopPropagation();</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div</span></p>
<p class="p1"><span class="s1">className="absolute flex flex-col items-center gap-1 w-20"</span></p>
<p class="p1"><span class="s1">style={{ left: pos.x, top: pos.y, zIndex: dragging ? 100 : 1 }}</span></p>
<p class="p1"><span class="s1">onMouseDown={(e) =&gt; {</span></p>
<p class="p1"><span class="s1">clickStartRef.current = Date.now();</span></p>
<p class="p1"><span class="s1">handleMouseDown(e);</span></p>
<p class="p1"><span class="s1">}}</span></p>
<p class="p1"><span class="s1">onClick={handleIconClick}</span></p>
<p class="p1"><span class="s1">&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="w-14 h-14 bg-white/90 rounded-xl shadow-lg flex items-center justify-center text-3xl pointer-events-none"&gt;</span></p>
<p class="p1"><span class="s1">{icons[icon.id]}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="text-xs text-white drop-shadow-md font-bold pointer-events-none bg-black/20 px-2 rounded-full"&gt;{labels[icon.id]}&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function BrowserApp({ gameState, onPost, posts, inventory }) {</span></p>
<p class="p1"><span class="s1">const [tab, setTab] = useState('home');</span></p>
<p class="p1"><span class="s1">const [caption, setCaption] = useState('');</span></p>
<p class="p1"><span class="s1">const [prompt, setPrompt] = useState('');</span></p>
<p class="p1"><span class="s1">const [imageUrl, setImageUrl] = useState('');</span></p>
<p class="p1"><span class="s1">const [imageSource, setImageSource] = useState('ai'); // 'ai', 'url', 'text'</span></p>
<p class="p1"><span class="s1">const [selectedItem, setSelectedItem] = useState(null);</span></p>
<p class="p1"><span class="s1">const [isPosting, setIsPosting] = useState(false);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const handleSubmit = async () =&gt; {</span></p>
<p class="p1"><span class="s1">if (!caption &amp;&amp; imageSource === 'text') return;</span></p>
<p class="p1"><span class="s1">if (imageSource === 'ai' &amp;&amp; !prompt) return;</span></p>
<p class="p1"><span class="s1">if (imageSource === 'url' &amp;&amp; !imageUrl) return;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">setIsPosting(true);</span></p>
<p class="p1"><span class="s1">await onPost(caption, prompt, imageUrl, imageSource, selectedItem);</span></p>
<p class="p1"><span class="s1">setIsPosting(false);</span></p>
<p class="p1"><span class="s1">setCaption(''); setPrompt(''); setImageUrl(''); setImageSource('ai'); setTab('home');</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const isImagePost = imageSource !== 'text';</span></p>
<p class="p1"><span class="s1">const postButtonDisabled = isPosting || (imageSource === 'ai' &amp;&amp; !prompt) || (imageSource === 'url' &amp;&amp; !imageUrl) || !caption;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="flex flex-col h-full bg-gray-100"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="bg-white p-2 border-b flex justify-between items-center px-4 sticky top-0 z-10"&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="font-bold text-pink-600"&gt;SweetGram&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="text-xs space-x-4"&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="font-bold"&gt;{gameState.fans} ç²‰ä¸&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; setTab('post')} className="bg-pink-500 text-white px-3 py-1 rounded-full text-xs"&gt;+ å‘å¸–&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex-1 overflow-y-auto"&gt;</span></p>
<p class="p1"><span class="s1">{tab === 'post' ? (</span></p>
<p class="p1"><span class="s1">&lt;div className="p-6 space-y-4"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h3 className="font-bold text-gray-700"&gt;å‘å¸ƒæ–°å†…å®¹&lt;/h3&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div&gt;</span></p>
<p class="p1"><span class="s1">&lt;label className="text-xs font-bold text-gray-500 block mb-1"&gt;å›¾ç‰‡æ¥æº&lt;/label&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex gap-3"&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; setImageSource('ai')} className={`px-3 py-1 text-sm rounded transition ${imageSource === 'ai' ? 'bg-blue-500 text-white' : 'bg-gray-200 hover:bg-gray-300'}`}&gt;AI ç”Ÿæˆ&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; setImageSource('url')} className={`px-3 py-1 text-sm rounded transition ${imageSource === 'url' ? 'bg-blue-500 text-white' : 'bg-gray-200 hover:bg-gray-300'}`}&gt;å¤–éƒ¨é“¾æ¥&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; setImageSource('text')} className={`px-3 py-1 text-sm rounded transition ${imageSource === 'text' ? 'bg-blue-500 text-white' : 'bg-gray-200 hover:bg-gray-300'}`}&gt;çº¯æ–‡å­—&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">{imageSource === 'ai' &amp;&amp; (</span></p>
<p class="p1"><span class="s1">&lt;div&gt;</span></p>
<p class="p1"><span class="s1">&lt;label className="text-xs font-bold text-gray-500 block mb-1"&gt;ç”»é¢æè¿° (Prompt)&lt;/label&gt;</span></p>
<p class="p1"><span class="s1">&lt;textarea className="w-full p-2 border rounded text-sm h-20" placeholder="ä¾‹å¦‚ï¼šåœ¨å§å®¤é•œå­å‰è‡ªæ‹..." value={prompt} onChange={e =&gt; setPrompt(e.target.value)}/&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">)}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">{imageSource === 'url' &amp;&amp; (</span></p>
<p class="p1"><span class="s1">&lt;div&gt;</span></p>
<p class="p1"><span class="s1">&lt;label className="text-xs font-bold text-gray-500 block mb-1"&gt;å›¾ç‰‡ URL (é“¾æ¥)&lt;/label&gt;</span></p>
<p class="p1"><span class="s1">&lt;input className="w-full p-2 border rounded text-sm" placeholder="ä¾‹å¦‚: https://placehold.co/400x400" value={imageUrl} onChange={e =&gt; setImageUrl(e.target.value)}/&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">)}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div&gt;</span></p>
<p class="p1"><span class="s1">&lt;label className="text-xs font-bold text-gray-500 block mb-1"&gt;é…æ–‡&lt;/label&gt;</span></p>
<p class="p1"><span class="s1">&lt;input className="w-full p-2 border rounded text-sm" placeholder="å†™ç‚¹ä»€ä¹ˆ..." value={caption} onChange={e =&gt; setCaption(e.target.value)}/&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">{isImagePost &amp;&amp; (</span></p>
<p class="p1"><span class="s1">&lt;div&gt;</span></p>
<p class="p1"><span class="s1">&lt;label className="text-xs font-bold text-gray-500 block mb-1"&gt;ç©¿æ­&lt;/label&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex gap-2 overflow-x-auto pb-2"&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; setSelectedItem(null)} className={`p-2 border rounded text-xs min-w-[60px] ${!selectedItem?'bg-blue-100':''}`}&gt;æ— &lt;/button&gt;</span></p>
<p class="p1"><span class="s1">{inventory.filter(i=&gt;['clothes','props'].includes(i.category)).map(item=&gt;(</span></p>
<p class="p1"><span class="s1">&lt;button key={item.id} onClick={()=&gt;setSelectedItem(item)} className={`p-2 border rounded text-xs min-w-[60px] ${selectedItem?.id===item.id?'bg-blue-100':''}`}&gt;{item.name}&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">)}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;button onClick={handleSubmit} disabled={postButtonDisabled} className="w-full bg-pink-500 text-white py-2 rounded font-bold flex justify-center items-center gap-2"&gt;</span></p>
<p class="p1"><span class="s1">{isPosting ? &lt;&gt;&lt;Loader className="animate-spin" size={16}/&gt; {imageSource === 'ai' ? 'ç”Ÿæˆå¹¶å‘å¸ƒä¸­...' : 'å‘å¸ƒä¸­...'}&lt;/&gt; : `å‘å¸ƒ (${imageSource === 'text' ? 'çº¯æ–‡å­—' : 'å¸¦å›¾ç‰‡'})`}</span></p>
<p class="p1"><span class="s1">&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; setTab('home')} className="w-full text-center text-xs text-gray-500 mt-2"&gt;å–æ¶ˆ&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">) : (</span></p>
<p class="p1"><span class="s1">&lt;div className="space-y-4 p-4"&gt;</span></p>
<p class="p1"><span class="s1">{posts.map(post =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;div key={post.id} className="bg-white rounded-lg border shadow-sm overflow-hidden"&gt;</span></p>
<p class="p1"><span class="s1">{post.imgSrc &amp;&amp; post.imgSrc !== 'TEXT' &amp;&amp; (</span></p>
<p class="p1"><span class="s1">&lt;div className="bg-black min-h-[200px] flex items-center justify-center"&gt;</span></p>
<p class="p1"><span class="s1">&lt;img src={post.imgSrc} alt="Generated" className="w-full h-auto object-cover" /&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">)}</span></p>
<p class="p1"><span class="s1">&lt;div className="p-3"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex items-center gap-2 mb-2 text-red-500"&gt;&lt;Heart size={16} fill="currentColor"/&gt; &lt;span className="text-sm font-bold"&gt;{post.likes}&lt;/span&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="text-sm mb-2"&gt;&lt;span className="font-bold mr-2"&gt;Kitty_01&lt;/span&gt;{post.desc}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">{post.comments &amp;&amp; &lt;div className="bg-gray-50 p-2 rounded text-xs space-y-1"&gt;{post.comments.map((c, i) =&gt; &lt;div key={i}&gt;&lt;span className="font-bold text-gray-600"&gt;user_{i}:&lt;/span&gt; {c}&lt;/div&gt;)}&lt;/div&gt;}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">{posts.length === 0 &amp;&amp; &lt;div className="col-span-4 text-center text-gray-400 mt-10"&gt;æš‚æ— å¸–æ–‡ï¼Œå¿«å»å‘å¸–å§&lt;/div&gt;}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">)}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function FinderApp({ gallery }) {</span></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="h-full bg-white flex flex-col"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="bg-gray-100 p-2 border-b text-sm font-bold flex gap-2"&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="text-blue-500"&gt;ç…§ç‰‡&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="text-gray-400"&gt;æ–‡æ¡£&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex-1 p-4 overflow-y-auto grid grid-cols-4 gap-4 content-start"&gt;</span></p>
<p class="p1"><span class="s1">{gallery.map(img =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;div key={img.id} className="aspect-square bg-gray-200 rounded overflow-hidden relative group border"&gt;</span></p>
<p class="p1"><span class="s1">&lt;img src={img.src} alt="Saved" className="w-full h-full object-cover" /&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] p-1 opacity-0 group-hover:opacity-100 truncate"&gt;</span></p>
<p class="p1"><span class="s1">{img.date}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">{gallery.length === 0 &amp;&amp; &lt;div className="col-span-4 text-center text-gray-400 mt-10"&gt;æš‚æ— ç…§ç‰‡ï¼Œå»å‘å¸–ç”Ÿæˆå§&lt;/div&gt;}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="p-2 border-t text-xs text-gray-500 text-center"&gt;{gallery.length} ä¸ªé¡¹ç›®&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function SettingsApp({ current, onChange, onReset }) {</span></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="h-full bg-gray-50 p-6"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h2 className="text-xl font-bold mb-6"&gt;ç³»ç»Ÿåå¥½è®¾ç½®&lt;/h2&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div className="mb-6"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h3 className="text-sm font-bold text-gray-500 mb-3 uppercase"&gt;æ¡Œé¢å£çº¸&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="grid grid-cols-2 gap-4"&gt;</span></p>
<p class="p1"><span class="s1">{WALLPAPERS.map(wp =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;button</span></p>
<p class="p1"><span class="s1">key={wp.id}</span></p>
<p class="p1"><span class="s1">onClick={() =&gt; onChange({ wallpaper: wp.id })}</span></p>
<p class="p1"><span class="s1">className={`h-20 rounded-lg shadow-sm border-2 ${wp.style} ${current.wallpaper === wp.id ? 'border-blue-500 ring-2 ring-blue-200' : 'border-transparent'}`}</span></p>
<p class="p1"><span class="s1">&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="bg-white/80 px-2 py-1 text-xs rounded-full"&gt;{wp.name}&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;div className="border-t pt-6"&gt;</span></p>
<p class="p1"><span class="s1">&lt;h3 className="text-sm font-bold text-gray-500 mb-3 uppercase"&gt;é«˜çº§é€‰é¡¹&lt;/h3&gt;</span></p>
<p class="p1"><span class="s1">&lt;button</span></p>
<p class="p1"><span class="s1">onClick={onReset}</span></p>
<p class="p1"><span class="s1">className="bg-red-500 text-white px-4 py-2 rounded shadow hover:bg-red-600 w-full"</span></p>
<p class="p1"><span class="s1">&gt;</span></p>
<p class="p1"><span class="s1">é‡ç½®æ‰€æœ‰æ¸¸æˆæ•°æ® (æ…ç”¨)</span></p>
<p class="p1"><span class="s1">&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function ShopApp({ currentCash, onBuy, inventory }) {</span></p>
<p class="p1"><span class="s1">const [category, setCategory] = useState('clothes');</span></p>
<p class="p1"><span class="s1">const filteredItems = SHOP_ITEMS.filter(i =&gt; i.category === category);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="flex flex-col h-full bg-gray-50"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="p-4 bg-orange-400 text-white shadow-md flex justify-between items-center"&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="font-bold text-lg flex items-center gap-2"&gt;&lt;ShoppingBag/&gt; Amazone&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="font-mono bg-orange-600 px-2 py-1 rounded"&gt;Â¥{(currentCash).toFixed(2)}&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex border-b bg-white text-sm"&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; setCategory('clothes')} className={`flex-1 p-2 ${category==='clothes'?'text-orange-500 border-b-2 border-orange-500':''}`}&gt;æœé¥°&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; setCategory('props')} className={`flex-1 p-2 ${category==='props'?'text-orange-500 border-b-2 border-orange-500':''}`}&gt;é“å…·&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={() =&gt; setCategory('electronics')} className={`flex-1 p-2 ${category==='electronics'?'text-orange-500 border-b-2 border-orange-500':''}`}&gt;ç”µå­&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-4"&gt;</span></p>
<p class="p1"><span class="s1">{filteredItems.map(item =&gt; {</span></p>
<p class="p1"><span class="s1">const owned = inventory.some(i =&gt; i.id === item.id);</span></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div key={item.id} className="bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex flex-col"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="h-20 bg-gray-100 mb-2 rounded flex items-center justify-center text-3xl"&gt;</span></p>
<p class="p1"><span class="s1">&lt;Package className="text-gray-400"/&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="font-bold text-sm"&gt;{item.name}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="text-xs text-gray-500 mb-2 h-8 leading-tight"&gt;{item.desc}&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="mt-auto flex justify-between items-center"&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="font-bold text-orange-600"&gt;Â¥{item.price}&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;button</span></p>
<p class="p1"><span class="s1">onClick={() =&gt; onBuy(item)}</span></p>
<p class="p1"><span class="s1">disabled={owned || currentCash &lt; item.price}</span></p>
<p class="p1"><span class="s1">className={`px-3 py-1 text-xs rounded text-white ${owned || currentCash &lt; item.price ? 'bg-gray-400 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600'}`}</span></p>
<p class="p1"><span class="s1">&gt;</span></p>
<p class="p1"><span class="s1">{owned ? 'å·²æ‹¥æœ‰' : 'è´­ä¹°'}</span></p>
<p class="p1"><span class="s1">&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">})}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function Window({ children, config, onClose }) {</span></p>
<p class="p1"><span class="s1">if (!config.isOpen) return null;</span></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div</span></p>
<p class="p1"><span class="s1">className="absolute bg-white rounded-lg shadow-2xl border border-gray-300 overflow-hidden flex flex-col"</span></p>
<p class="p1"><span class="s1">style={{</span></p>
<p class="p1"><span class="s1">width: '600px', height: '450px',</span></p>
<p class="p1"><span class="s1">left: '50%', top: '50%', transform: 'translate(-50%, -50%)',</span></p>
<p class="p1"><span class="s1">zIndex: config.z</span></p>
<p class="p1"><span class="s1">}}</span></p>
<p class="p1"><span class="s1">&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="h-8 bg-gray-100 border-b flex items-center px-3 justify-between"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex gap-2"&gt;</span></p>
<p class="p1"><span class="s1">&lt;button onClick={onClose} className="w-3 h-3 rounded-full bg-red-500 hover:bg-red-600"/&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="w-3 h-3 rounded-full bg-yellow-500"/&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="w-3 h-3 rounded-full bg-green-500"/&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="text-xs font-bold text-gray-600"&gt;{config.title}&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="w-10"/&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex-1 overflow-hidden relative"&gt;</span></p>
<p class="p1"><span class="s1">{children}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function MenuBar({ gameState, currentCash }) {</span></p>
<p class="p1"><span class="s1">const formatTime = (h, m) =&gt; `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;</span></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="h-8 bg-white/90 backdrop-blur border-b flex items-center justify-between px-4 text-xs fixed top-0 w-full z-[1000] font-mono"&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="font-bold text-lg"&gt;PixelOS&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;div className="flex gap-4"&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="text-red-500 flex items-center gap-1"&gt;&lt;Heart size={12}/&gt; {Math.floor(gameState.health)}%&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="text-blue-500 flex items-center gap-1"&gt;&lt;Cpu size={12}/&gt; San: {Math.floor(gameState.sanity)}%&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="text-purple-500 flex items-center gap-1"&gt;&lt;BookOpen size={12}/&gt; GPA: {Math.floor(gameState.academics)}&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;span className="text-green-600 font-bold"&gt;Â¥{(currentCash).toFixed(1)}&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;span&gt;Day {gameState.day} {formatTime(gameState.hour, gameState.minute)}&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function Dock({ windows, setWindows }) {</span></p>
<p class="p1"><span class="s1">const icons = {</span></p>
<p class="p1"><span class="s1">browser: &lt;Globe className="text-blue-500"/&gt;,</span></p>
<p class="p1"><span class="s1">chat: &lt;MessageCircle className="text-green-500"/&gt;,</span></p>
<p class="p1"><span class="s1">shop: &lt;ShoppingBag className="text-orange-500"/&gt;,</span></p>
<p class="p1"><span class="s1">bank: &lt;DollarSign className="text-yellow-600"/&gt;,</span></p>
<p class="p1"><span class="s1">finder: &lt;Square className="text-gray-500 fill-blue-400"/&gt;,</span></p>
<p class="p1"><span class="s1">food: &lt;Utensils className="text-yellow-500"/&gt;,</span></p>
<p class="p1"><span class="s1">hospital: &lt;Stethoscope className="text-red-500"/&gt;,</span></p>
<p class="p1"><span class="s1">study: &lt;GraduationCap className="text-purple-500"/&gt;,</span></p>
<p class="p1"><span class="s1">stonks: &lt;TrendingUp className="text-green-600"/&gt;,</span></p>
<p class="p1"><span class="s1">settings: &lt;Settings className="text-gray-600"/&gt;</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">return (</span></p>
<p class="p1"><span class="s1">&lt;div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/70 backdrop-blur rounded-2xl p-2 flex gap-4 shadow-xl pointer-events-auto"&gt;</span></p>
<p class="p1"><span class="s1">{Object.entries(windows).map(([key, win]) =&gt; (</span></p>
<p class="p1"><span class="s1">&lt;button</span></p>
<p class="p1"><span class="s1">key={key}</span></p>
<p class="p1"><span class="s1">onClick={() =&gt; setWindows(p =&gt; ({...p, [key]: {...p[key], isOpen: true, z: Date.now()}}))}</span></p>
<p class="p1"><span class="s1">className="w-12 h-12 bg-white rounded-xl flex items-center justify-center hover:-translate-y-2 transition-transform shadow-sm relative group"</span></p>
<p class="p1"><span class="s1">&gt;</span></p>
<p class="p1"><span class="s1">{icons[key]}</span></p>
<p class="p1"><span class="s1">{win.isOpen &amp;&amp; &lt;div className="absolute -bottom-1 w-1 h-1 bg-gray-500 rounded-full"/&gt;}</span></p>
<p class="p1"><span class="s1">&lt;div className="absolute -top-10 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap"&gt;</span></p>
<p class="p1"><span class="s1">{win.title}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/button&gt;</span></p>
<p class="p1"><span class="s1">))}</span></p>
<p class="p1"><span class="s1">&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">);</span></p>
<p class="p1"><span class="s1">}</span></p>
</body>
</html>
